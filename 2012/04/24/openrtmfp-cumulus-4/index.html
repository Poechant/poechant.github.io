<!DOCTYPE html>
<html>

<head>
	<!-- Meta -->
	<meta charset="UTF-8"/>
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
	<meta name="generator" content="Jekyll">

	<title>麦克船长的 OpenRTMFP/Cumulus 原理、源码及实践 4：AMF 解析源码分析</title>
  	<meta name="description" content="本文是麦克船长《OpenRTMFP/Cumulus 原理、源码及实践》系列文章的其中一篇，相关内容最初首发于 CSDN 的 Poechant 技术博客，后整理于本博客。本篇文章主要介绍 ActionScript 独有的 AMF 数据格式，并对其序列化和反序列化的源码进行详细解读。">

	<!-- CSS & fonts -->
	<link rel="stylesheet" href="/css/main.css">

	<!-- RSS -->
	<link href="/atom.xml" type="application/atom+xml" rel="alternate" title="ATOM Feed" />

  	<!-- Favicon -->
 	 <link rel="shortcut icon" type="image/png" href="/img/favicon.png">

 	 <!-- Syntax highlighter -->
  	<link rel="stylesheet" href="/css/syntax.css" />

  	<!--KaTeX-->
  	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
  	<script defer src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js" integrity="sha384-g7c+Jr9ZivxKLnZTDUhnkOnsh30B4H0rpLUpJ4jAIKs4fnJI+sEnkvrMWph2EDg4" crossorigin="anonymous"></script>
  	<script defer src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/auto-render.min.js" integrity="sha384-mll67QQFJfxn0IYznZYonOWZ644AWYC+Pt2cHqMaRhXVrursRwvLnLaebdGIlYNa" crossorigin="anonymous"></script>
  	<script>
  		document.addEventListener("DOMContentLoaded", function() {
  			renderMathInElement(document.body, {
  				// ...options...
  			});
  		});
  	</script>

  	

  	
  		<script async src="https://www.googletagmanager.com/gtag/js?id=G-CH4708X4R5"></script>
  		<script>
    		window.dataLayer = window.dataLayer || [];
    		function gtag(){dataLayer.push(arguments);}
    		gtag('js', new Date());

    		gtag('config', 'G-CH4708X4R5');
  		</script>
	


</head>

<body>
	<div id="wrap">
	  	
	  	<!-- Navigation -->
	  	<nav id="nav">
	<div id="nav-list">
		<a href="/">Home</a>

		<!-- Nav pages -->
	  <!-- 
	    
	  
	    
	      <a href="/about/" title="关于我">关于我</a>
	    
	  
	    
	  
	    
	  
	    
	      <a href="/booklist/" title="读书行路">读书行路</a>
	    
	  
	    
	  
	    
	      <a href="/categories/" title="Categories">Categories</a>
	    
	  
	    
	  
	    
	  
	    
	  
	    
	  
	    
	  
	    
	  
	    
	  
	    
	  
	    
	  
	    
	  
	    
	   -->

	  <!-- Tech category pages -->






  <a href="/category/ai" title="AI">AI</a>















  <a href="/category/rt_tech" title="RT">RT</a>







  <a href="/category/web" title="前端">前端</a>














<!-- Non-tech category pages -->












  <a href="/category/design" title="设计">设计</a>











  <a href="/category/server" title="后端">后端</a>



  <a href="/category/thinking" title="思考">思考</a>















	  
        
      
        
          <a href="/about/" title="关于我">关于我</a>
        
      
        
      
        
      
        
          <a href="/booklist/" title="读书行路">读书行路</a>
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    <!-- Nav links -->
	  <!-- <a href="https://github.com/thereviewindex/monochrome/archive/master.zip">Download</a>
<a href="https://github.com/thereviewindex/monochrome">Project on Github</a> -->

	</div>
  
  <!-- Nav footer -->
	
	  <footer>
	
	<span>version 1.0.0</span>

</footer>
	

</nav>

    
    <!-- Icon menu -->
	  <a id="nav-menu">
	  	<div id="menu"></div>
	  </a>

      <!-- Header -->
      
        <header id="header" class="parent justify-spaceBetween">
  <div class="inner w100 relative">
    <span class="f-left">  
      <a href="/">
        <h1>
          <span>Mike</span>Captain
        </h1>
      </a>
    </span>
    <span id="nav-links" class="absolute right bottom">

      <!-- Tech category pages -->






  <a href="/category/ai" title="AI">AI</a>















  <a href="/category/rt_tech" title="RT">RT</a>







  <a href="/category/web" title="前端">前端</a>














<!-- Non-tech category pages -->












  <a href="/category/design" title="设计">设计</a>











  <a href="/category/server" title="后端">后端</a>



  <a href="/category/thinking" title="思考">思考</a>















      &nbsp;&nbsp;&nbsp;丨&nbsp;

      <!-- Nav pages -->
      
        
      
        
          <a href="/about/" title="关于我">关于我</a>
        
      
        
      
        
      
        
          <a href="/booklist/" title="读书行路">读书行路</a>
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
      
      <!-- Nav links -->
      <!-- <a href="https://github.com/thereviewindex/monochrome/archive/master.zip">Download</a>
<a href="https://github.com/thereviewindex/monochrome">Project on Github</a> -->

    </span>
  </div>
</header>




      

    <!-- Main content -->
	  <div id="container">

		<main>

			<article id="post-page">
	<h2>麦克船长的 OpenRTMFP/Cumulus 原理、源码及实践 4：AMF 解析源码分析</h2>		
	<time datetime="2012-04-24T10:04:55+08:00" class="by-line">24 Apr 2012, 广州 | 麦克船长 | 总计 30820 字</time>
	<div class="content">
		<p><strong>本文目录</strong></p>
<ul id="markdown-toc">
  <li><a href="#一amf-数据类型定义" id="markdown-toc-一amf-数据类型定义">一、AMF 数据类型定义</a>    <ul>
      <li><a href="#1数据类型" id="markdown-toc-1数据类型">1、数据类型</a></li>
      <li><a href="#2undefined-type" id="markdown-toc-2undefined-type">2、<code class="language-plaintext highlighter-rouge">undefined</code> Type</a></li>
      <li><a href="#3null-type" id="markdown-toc-3null-type">3、<code class="language-plaintext highlighter-rouge">null</code> Type</a></li>
      <li><a href="#4false-type" id="markdown-toc-4false-type">4、<code class="language-plaintext highlighter-rouge">false</code> type</a></li>
      <li><a href="#5true-type" id="markdown-toc-5true-type">5、<code class="language-plaintext highlighter-rouge">true</code> type</a></li>
      <li><a href="#6integer-type" id="markdown-toc-6integer-type">6、<code class="language-plaintext highlighter-rouge">integer</code> type</a></li>
      <li><a href="#7double-type" id="markdown-toc-7double-type">7、<code class="language-plaintext highlighter-rouge">double</code> type</a></li>
      <li><a href="#8string-type" id="markdown-toc-8string-type">8、<code class="language-plaintext highlighter-rouge">String</code> type</a></li>
      <li><a href="#9xmldocument-type" id="markdown-toc-9xmldocument-type">9、<code class="language-plaintext highlighter-rouge">XMLDocument</code> type</a></li>
      <li><a href="#10date-type" id="markdown-toc-10date-type">10、<code class="language-plaintext highlighter-rouge">Date</code> type</a></li>
      <li><a href="#11array-type" id="markdown-toc-11array-type">11、<code class="language-plaintext highlighter-rouge">Array</code> type</a></li>
      <li><a href="#12object-type" id="markdown-toc-12object-type">12、<code class="language-plaintext highlighter-rouge">Object</code> type</a></li>
      <li><a href="#13xml-type" id="markdown-toc-13xml-type">13、<code class="language-plaintext highlighter-rouge">XML</code> type</a></li>
      <li><a href="#14bytearray-type" id="markdown-toc-14bytearray-type">14、<code class="language-plaintext highlighter-rouge">ByteArray</code> type</a></li>
      <li><a href="#15amf3-的使用" id="markdown-toc-15amf3-的使用">15、AMF3 的使用</a>        <ul>
          <li><a href="#151netconnection-and-amf-3" id="markdown-toc-151netconnection-and-amf-3">15.1、<code class="language-plaintext highlighter-rouge">NetConnection</code> and AMF 3</a></li>
          <li><a href="#152netconnection-in-actionscript-30" id="markdown-toc-152netconnection-in-actionscript-30">15.2、<code class="language-plaintext highlighter-rouge">NetConnection</code> in ActionScript 3.0</a></li>
          <li><a href="#153bytearray-idatainput-and-idataoutput" id="markdown-toc-153bytearray-idatainput-and-idataoutput">15.3、<code class="language-plaintext highlighter-rouge">ByteArray</code>, <code class="language-plaintext highlighter-rouge">IDataInput</code> and <code class="language-plaintext highlighter-rouge">IDataOutput</code></a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#二binaryreaderwriter" id="markdown-toc-二binaryreaderwriter">二、<code class="language-plaintext highlighter-rouge">BinaryReader/Writer</code></a>    <ul>
      <li><a href="#1amf3-数据格式基础" id="markdown-toc-1amf3-数据格式基础">1、AMF3 数据格式基础</a></li>
      <li><a href="#2序列化" id="markdown-toc-2序列化">2、序列化</a></li>
      <li><a href="#3反序列化" id="markdown-toc-3反序列化">3、反序列化</a></li>
    </ul>
  </li>
  <li><a href="#三packetreaderwriter" id="markdown-toc-三packetreaderwriter">三、<code class="language-plaintext highlighter-rouge">PacketReader/Writer</code></a>    <ul>
      <li><a href="#1packetreader" id="markdown-toc-1packetreader">1、PacketReader</a>        <ul>
          <li><a href="#11封装-memoryinputstream" id="markdown-toc-11封装-memoryinputstream">1.1、封装 <code class="language-plaintext highlighter-rouge">MemoryInputStream</code></a></li>
          <li><a href="#12收缩缓冲区" id="markdown-toc-12收缩缓冲区">1.2、收缩缓冲区</a></li>
          <li><a href="#13构造函数拷贝构造函数和析构函数" id="markdown-toc-13构造函数拷贝构造函数和析构函数">1.3、构造函数、拷贝构造函数和析构函数</a></li>
        </ul>
      </li>
      <li><a href="#2packetwriter" id="markdown-toc-2packetwriter">2、<code class="language-plaintext highlighter-rouge">PacketWriter</code></a>        <ul>
          <li><a href="#21封装memoryoutputstream" id="markdown-toc-21封装memoryoutputstream">2.1、封装<code class="language-plaintext highlighter-rouge">MemoryOutputStream</code></a></li>
          <li><a href="#22封装-binarywriter" id="markdown-toc-22封装-binarywriter">2.2、封装 <code class="language-plaintext highlighter-rouge">BinaryWriter</code></a></li>
          <li><a href="#23构造函数拷贝构造函数和析构函数" id="markdown-toc-23构造函数拷贝构造函数和析构函数">2.3、构造函数、拷贝构造函数和析构函数</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#四amfreader" id="markdown-toc-四amfreader">四、<code class="language-plaintext highlighter-rouge">AMFReader</code></a>    <ul>
      <li><a href="#1objectdef" id="markdown-toc-1objectdef">1、<code class="language-plaintext highlighter-rouge">ObjectDef</code></a></li>
      <li><a href="#2amfreader-定义" id="markdown-toc-2amfreader-定义">2、<code class="language-plaintext highlighter-rouge">AMFReader</code> 定义</a>        <ul>
          <li><a href="#21构造函数析构函数" id="markdown-toc-21构造函数析构函数">2.1、构造函数、析构函数</a></li>
          <li><a href="#22简单封装-packetreader-的一些函数" id="markdown-toc-22简单封装-packetreader-的一些函数">2.2、简单封装 <code class="language-plaintext highlighter-rouge">PacketReader</code> 的一些函数</a></li>
          <li><a href="#23设置-gptr-位置" id="markdown-toc-23设置-gptr-位置">2.3、设置 <code class="language-plaintext highlighter-rouge">gptr</code> 位置</a></li>
          <li><a href="#24判断类型" id="markdown-toc-24判断类型">2.4、判断类型</a></li>
        </ul>
      </li>
      <li><a href="#3解析-as3-null" id="markdown-toc-3解析-as3-null">3、解析 AS3 <code class="language-plaintext highlighter-rouge">Null</code></a></li>
      <li><a href="#4解析-as3-number" id="markdown-toc-4解析-as3-number">4、解析 AS3 <code class="language-plaintext highlighter-rouge">Number</code></a></li>
      <li><a href="#5解析-as3-integer" id="markdown-toc-5解析-as3-integer">5、解析 AS3 <code class="language-plaintext highlighter-rouge">Integer</code></a></li>
      <li><a href="#6解析-as3-boolean" id="markdown-toc-6解析-as3-boolean">6、解析 AS3 <code class="language-plaintext highlighter-rouge">Boolean</code></a></li>
      <li><a href="#7开始引用与结束引用" id="markdown-toc-7开始引用与结束引用">7、开始引用与结束引用</a></li>
      <li><a href="#8解析-as3-bytearray" id="markdown-toc-8解析-as3-bytearray">8、解析 AS3 <code class="language-plaintext highlighter-rouge">ByteArray</code></a></li>
      <li><a href="#9解析-as3-date" id="markdown-toc-9解析-as3-date">9、解析 AS3 <code class="language-plaintext highlighter-rouge">Date</code></a></li>
      <li><a href="#10解析-as3-dictionary" id="markdown-toc-10解析-as3-dictionary">10、解析 AS3 <code class="language-plaintext highlighter-rouge">Dictionary</code></a></li>
    </ul>
  </li>
</ul>

<p>本文是麦克船长《OpenRTMFP/Cumulus 原理、源码及实践》系列文章的其中一篇，相关内容最初首发于 CSDN 的 Poechant 技术博客，后整理于本博客。本篇文章主要介绍 ActionScript 独有的 AMF 数据格式，并对其序列化和反序列化的源码进行详细解读。</p>

<h3 id="一amf-数据类型定义">一、AMF 数据类型定义</h3>

<h4 id="1数据类型">1、数据类型</h4>

<p>各种数据类型的标示都在 AMF.h 中定义为宏</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#define AMF_NUMBER              0x00    // 浮点数
#define AMF_BOOLEAN             0x01    // 布尔型
#define AMF_STRING              0x02    // 字符串
#define AMF_BEGIN_OBJECT        0x03    // 对象，开始
#define AMF_NULL                0x05    // null
#define AMF_UNDEFINED           0x06
#define AMF_REFERENCE           0x07
#define AMF_MIXED_ARRAY         0x08
#define AMF_END_OBJECT          0x09    // 对象，结束
#define AMF_BEGIN_TYPED_OBJECT  0x10
#define AMF_STRICT_ARRAY        0x0A
#define AMF_DATE                0x0B    // 日期
#define AMF_LONG_STRING         0x0C    // 字符串
#define AMF_UNSUPPORTED         0x0D
</span> 
<span class="cp">#define AMF_AVMPLUS_OBJECT  0x11
#define AMF_END             0xFF
</span> 
<span class="cp">#define AMF3_UNDEFINED      0x00
#define AMF3_NULL           0x01
#define AMF3_FALSE          0x02
#define AMF3_TRUE           0x03
#define AMF3_INTEGER        0x04
#define AMF3_NUMBER         0x05
#define AMF3_STRING         0x06
#define AMF3_DATE           0x08
#define AMF3_ARRAY          0x09
#define AMF3_OBJECT         0x0A
#define AMF3_BYTEARRAY      0x0C
#define AMF3_DICTIONARY     0x11
</span></code></pre></div></div>

<p>并定义了一个枚举类表示数据类型：</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">AMF</span> <span class="p">{</span>
<span class="nl">public:</span>
    <span class="k">enum</span> <span class="n">Type</span> <span class="p">{</span>
        <span class="n">Null</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">Boolean</span><span class="p">,</span>
        <span class="n">Integer</span><span class="p">,</span>
        <span class="n">Number</span><span class="p">,</span>
        <span class="n">String</span><span class="p">,</span>
        <span class="n">Date</span><span class="p">,</span>
        <span class="n">Array</span><span class="p">,</span>
        <span class="n">Object</span><span class="p">,</span>
        <span class="n">ByteArray</span><span class="p">,</span>
        <span class="n">Dictionary</span><span class="p">,</span>
        <span class="n">RawObjectContent</span><span class="p">,</span>
        <span class="n">End</span>
    <span class="p">};</span>
<span class="p">};</span>
</code></pre></div></div>

<h4 id="2undefined-type">2、<code class="language-plaintext highlighter-rouge">undefined</code> Type</h4>

<p><code class="language-plaintext highlighter-rouge">undefined</code> 类型由 <code class="language-plaintext highlighter-rouge">undefined</code> 类型标记表示。此值不会编码任何其他信息。</p>

<h4 id="3null-type">3、<code class="language-plaintext highlighter-rouge">null</code> Type</h4>

<p><code class="language-plaintext highlighter-rouge">null</code> 类型由 <code class="language-plaintext highlighter-rouge">null</code> 类型标记表示。此值不会编码任何其他信息。</p>

<h4 id="4false-type">4、<code class="language-plaintext highlighter-rouge">false</code> type</h4>

<p><code class="language-plaintext highlighter-rouge">false</code> 类型由 <code class="language-plaintext highlighter-rouge">false</code> 类型标记表示，用于编码布尔值 <code class="language-plaintext highlighter-rouge">false</code>。注意，在 ActionScript 3.0 中，布尔值的原始形式和对象形式不存在。此值不会编码任何其他信息。</p>

<h4 id="5true-type">5、<code class="language-plaintext highlighter-rouge">true</code> type</h4>

<p>true 类型由 true 类型标记表示，用于编码布尔值 true。注意，在 ActionScript 3.0 中，布尔值的原始形式和对象形式不存在。此值不会编码任何其他信息。</p>

<h4 id="6integer-type">6、<code class="language-plaintext highlighter-rouge">integer</code> type</h4>

<p>在 AMF 3 中，整数使用可变长度的无符号 29 位整数进行序列化。ActionScript 3.0 中的整数类型 - 有符号 <code class="language-plaintext highlighter-rouge">int</code> 类型和无符号 <code class="language-plaintext highlighter-rouge">uint</code> 类型 - 也使用 29 位在 AVM+中表示。如果无符号整数 (<code class="language-plaintext highlighter-rouge">uint</code>) 的值大于等于 229 或者如果有符号整数 (<code class="language-plaintext highlighter-rouge">int</code>) 的值大于等于 228，则它将被 AVM+ 表示为 <code class="language-plaintext highlighter-rouge">double</code> 类型，并使用 AMF 3 double 类型进行序列化。</p>

<h4 id="7double-type">7、<code class="language-plaintext highlighter-rouge">double</code> type</h4>

<p>AMF 3 的 <code class="language-plaintext highlighter-rouge">double</code> 类型与 AMF 0 的 <code class="language-plaintext highlighter-rouge">Number</code> 类型编码方式相同。此类型用于编码 ActionScript <code class="language-plaintext highlighter-rouge">Number</code> 或值大于等于 228 的 ActionScript <code class="language-plaintext highlighter-rouge">int</code> 或值大于等于 229 的 ActionScript <code class="language-plaintext highlighter-rouge">uint</code>。编码值始终是网络字节顺序中的 8 字节 IEEE-754 双精度浮点值 (低内存中的符号位)。</p>

<h4 id="8string-type">8、<code class="language-plaintext highlighter-rouge">String</code> type</h4>

<p>ActionScript String 值使用 AMF 3 中的单个 string 类型表示 - AMF 0 中的 <code class="language-plaintext highlighter-rouge">string</code> 和 <code class="language-plaintext highlighter-rouge">long string</code> 类型的概念不再使用。可以使用对隐式字符串引用表中的索引将字符串作为先前发生的字符串的引用发送。字符串使用 UTF-8 编码 - 但是头可以描述字符串文本或字符串引用。空字符串永远不会作为引用发送。</p>

<h4 id="9xmldocument-type">9、<code class="language-plaintext highlighter-rouge">XMLDocument</code> type</h4>

<p>ActionScript 3.0 引入了新的 XML 类型 (参见 3.13)，但是旧版的 XMLDocument 类型在语言中被保留为 <code class="language-plaintext highlighter-rouge">flash.xml.XMLDocument</code>。与 AMF 0 类似，<code class="language-plaintext highlighter-rouge">XMLDocument</code> 的结构需要扁平化为字符串表示以进行序列化。与 AMF 中的其他字符串一样，内容使用 UTF-8 编码。XMLDocuments 可以通过使用对隐式对象引用表中的索引作为先前发生的 <code class="language-plaintext highlighter-rouge">XMLDocument</code> 实例的引用发送。</p>

<h4 id="10date-type">10、<code class="language-plaintext highlighter-rouge">Date</code> type</h4>

<p>在 AMF 3 中，ActionScript Date 简单地作为自 1970 年 1 月 1 日午夜 (UTC 时区) 以来的毫秒数进行序列化。不发送本地时区信息。可以使用对隐式对象引用表中的索引将日期作为先前发生的日期实例的引用发送。</p>

<h4 id="11array-type">11、<code class="language-plaintext highlighter-rouge">Array</code> type</h4>

<p>ActionScript 数组的类型和在数组中的位置是基于它们的索引性质描述的。以下表格概述了这些术语的含义：</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">strict</code>：仅包含序数（数字）索引</li>
  <li><code class="language-plaintext highlighter-rouge">dense</code>：序数索引从 0 开始，并且在连续索引之间不存在间隙（即，从 0 到数组长度的每一个索引都被定义了）</li>
  <li><code class="language-plaintext highlighter-rouge">sparse</code>：包含至少两个索引之间的一个间隙</li>
  <li><code class="language-plaintext highlighter-rouge">associative</code>：包含至少一个非序数（字符串）索引（有时称为 ECMA 数组）</li>
</ul>

<p>AMF 将数组分为两部分，密集部分和关联部分。关联部分的二进制表示由名称/值对（可能没有）终止的空字符串。密集部分的二进制表示由密集部分的大小（可能为零）以及有序的值列表（可能没有）组成。在 AMF 中写入的顺序是密集部分的大小，一个以空字符串终止的名称/值对列表，然后是大小的值。数组可以通过使用隐式对象引用表的索引作为先前发生的数组的引用来发送。</p>

<h4 id="12object-type">12、<code class="language-plaintext highlighter-rouge">Object</code> type</h4>

<p>AMF 3 中有一种类型用于处理 ActionScript 对象和自定义用户类。使用术语 “traits” 来描述类的定义特征。除了 “anonymous” 对象和 “typed” 对象，ActionScript 3.0 还引入了两个进一步的 traits 来描述如何序列化对象，即 “dynamic” 和 “externalizable”。以下表格概述了这些术语和它们的含义：</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">Anonymous</code>：实际的 ActionScript 对象类型的实例或没有注册别名的类的实例（在反序列化时将其视为对象）。</li>
  <li><code class="language-plaintext highlighter-rouge">Typed</code>：具有注册别名的类的实例。</li>
  <li><code class="language-plaintext highlighter-rouge">Dynamic</code>：具有动态特征声明的类定义的实例；可以在运行时动态地从实例中添加和删除公共变量成员。</li>
  <li><code class="language-plaintext highlighter-rouge">Externalizable</code>：实现 flash.utils.IExternalizable 的类的实例，它完全控制其成员的序列化（特征信息中不包含属性名）。</li>
</ul>

<p>在这些特征之外，对象的特征信息还可能包括在类上定义的一组公共变量和公共可读写属性名称（即不是函数的公共成员）。成员名称的顺序很重要，因为在特征信息之后的成员值将按照完全相同的顺序出现。这些成员被视为密封成员，因为它们是由类型明确定义的。</p>

<p>如果类型是动态的，则在密封成员之后可以包括一个进一步的部分，该部分将动态成员列为名称/值对。当遇到空字符串名称时，继续读取动态成员。</p>

<p>对象可以通过使用隐式对象引用表中的索引来作为先前发生对象的引用。此外，还可以通过使用隐式特征引用表中的索引将特征信息发送为先前发生的一组特征的引用。</p>

<h4 id="13xml-type">13、<code class="language-plaintext highlighter-rouge">XML</code> type</h4>

<p>ActionScript 3.0 引入了一种新的 <code class="language-plaintext highlighter-rouge">XML</code> 类型，支持 E4X 语法。为了序列化，需要将 <code class="language-plaintext highlighter-rouge">XML</code> 类型展平成字符串表示形式。与 AMF 中的其他字符串一样，内容使用 UTF-8 编码。<code class="language-plaintext highlighter-rouge">XML</code> 实例可以通过使用对隐式对象引用表中的索引作为先前发生的 XML 实例的引用发送。请注意，这种编码对 <code class="language-plaintext highlighter-rouge">XML</code> 的使用造成了一些理论限制。每个 UTF-8 编码的 <code class="language-plaintext highlighter-rouge">XML</code> 实例的字节长度最大为 228-1 字节（大约 256 MB）。</p>

<h4 id="14bytearray-type">14、<code class="language-plaintext highlighter-rouge">ByteArray</code> type</h4>

<p>用于保存字节数组，即 <code class="language-plaintext highlighter-rouge">ByteArray</code>。AMF 3 使用可变长度编码 29 位整数序列化此类型，其中包括字节长度前缀，然后是 <code class="language-plaintext highlighter-rouge">ByteArray</code> 的原始字节。<code class="language-plaintext highlighter-rouge">ByteArray</code> 实例可以通过使用对隐式对象引用表中的索引作为先前发生的 <code class="language-plaintext highlighter-rouge">ByteArray</code> 实例的引用发送。</p>

<h4 id="15amf3-的使用">15、AMF3 的使用</h4>

<h5 id="151netconnection-and-amf-3">15.1、<code class="language-plaintext highlighter-rouge">NetConnection</code> and AMF 3</h5>

<p>除了序列化 ActionScript 类型外，AMF 还可用于远程服务的异步调用。可使用简单的消息结构将一批请求发送到远程端点。此消息结构的格式为 AMF 0（参见[AMF0]）。可以使用特殊的 <code class="language-plaintext highlighter-rouge">avmplus-object-marker</code> 类型将上下文头值或消息正文切换到 AMF 3 编码。</p>

<h5 id="152netconnection-in-actionscript-30">15.2、<code class="language-plaintext highlighter-rouge">NetConnection</code> in ActionScript 3.0</h5>

<p>在 ActionScript 3.0 中，NetConnection 的限定类名是 flash.net.NetConnection。这个类仍然使用响应器来处理远程端点的结果和状态响应，但是现在需要强类型的 Responder 类。完全限定的类名是 flash.net.Responder。除了正常的结果和状态响应之外，NetConnection 还会分发事件，开发人员可以添加监听器。下面是这些事件的概述：</p>

<ul>
  <li>当异常异步抛出时触发，例如来自本机异步代码。</li>
  <li>当输入或输出错误导致网络操作失败时触发。</li>
  <li>当 NetConnection 对象报告其状态或错误条件时触发。</li>
  <li>如果对 NetConnection.call() 的调用尝试连接到调用者安全沙箱外的服务器，则会触发。</li>
</ul>

<h5 id="153bytearray-idatainput-and-idataoutput">15.3、<code class="language-plaintext highlighter-rouge">ByteArray</code>, <code class="language-plaintext highlighter-rouge">IDataInput</code> and <code class="language-plaintext highlighter-rouge">IDataOutput</code></h5>

<p>ActionScript 3.0 引入了一种新类型，用于支持以字节数组形式处理原始数据，即 <code class="language-plaintext highlighter-rouge">flash.utils.ByteArray</code>。为了协助 ActionScript 对象序列化和复制，<code class="language-plaintext highlighter-rouge">ByteArray</code> 实现了 <code class="language-plaintext highlighter-rouge">flash.utils.IDataInput</code> 和 <code class="language-plaintext highlighter-rouge">flash.utils.IDataOutput</code>。这些接口指定了帮助将常见类型写入字节流的实用方法。两个感兴趣的方法是 <code class="language-plaintext highlighter-rouge">IDataOutput.writeObject</code> 和 <code class="language-plaintext highlighter-rouge">IDataInput.readObject</code>。这些方法使用 AMF 编码对象。使用的 AMF 版本由 <code class="language-plaintext highlighter-rouge">ByteArray.objectEncoding</code> 方法控制，该方法可以设置为 AMF 3 或 AMF 0。枚举类型 <code class="language-plaintext highlighter-rouge">flash.net.ObjectEncoding</code> 包含 AMF 版本的常量：分别为 <code class="language-plaintext highlighter-rouge">ObjectEncoding.AMF0</code> 和 <code class="language-plaintext highlighter-rouge">ObjectEncoding.AMF3</code>。</p>

<p>请注意，<code class="language-plaintext highlighter-rouge">ByteArray.writeObject</code> 使用一个版本的 AMF 对整个对象进行编码。与 <code class="language-plaintext highlighter-rouge">NetConnection</code> 不同，<code class="language-plaintext highlighter-rouge">ByteArray</code> 不会从 AMF 0 开始，然后将 <code class="language-plaintext highlighter-rouge">objectEncoding</code> 属性设置为 AMF 3 并切换到 AMF 3。还请注意，<code class="language-plaintext highlighter-rouge">ByteArray</code> 为每个 <code class="language-plaintext highlighter-rouge">readObject</code> 和 <code class="language-plaintext highlighter-rouge">writeObject</code> 调用使用新的对象、对象特征和字符串的隐式引用表。</p>

<h3 id="二binaryreaderwriter">二、<code class="language-plaintext highlighter-rouge">BinaryReader/Writer</code></h3>

<h4 id="1amf3-数据格式基础">1、AMF3 数据格式基础</h4>

<p>首先介绍一下变长整数（Variable Length Integer），比如 UInt32 如下。</p>

<p><img src="/img/src/2012-04-24-openrtmfp-cumulus-4-1.png" alt="image" /></p>

<p>上图摘自 Adobe AMF3 官方文档，这是一种压缩方式的整数存储，且每一字节都对后面的数据具有预知作用。那么字符串如何处理呢？下面是字符串的处理方式，AMF0 和 AMF3 都才用 UTF-8 编码方式，并做如下压缩处理：</p>

<p><img src="/img/src/2012-04-24-openrtmfp-cumulus-4-2.png" alt="image" /></p>

<p>上图摘自 Adobe AMF3 官方文档。</p>

<h4 id="2序列化">2、序列化</h4>

<p>序列化包括 8 位、16 位、32 位，以及 UTF-8 和 UTF-16（I guess）编码的 String，还有原生数据（Raw Data）、变长无符号整数（Variable Length Unsigned Integer）以及 IP 地址。所谓序列化就是按照指定格式编写各种对象、基础数据类型值。</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">BinaryWriter</span> <span class="o">:</span> <span class="k">public</span> <span class="n">Poco</span><span class="o">::</span><span class="n">BinaryWriter</span> <span class="p">{</span>
<span class="nl">public:</span>
    <span class="n">BinaryWriter</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span> <span class="n">ostr</span><span class="p">);</span>
    <span class="k">virtual</span> <span class="o">~</span><span class="n">BinaryWriter</span><span class="p">();</span>
    <span class="kt">void</span> <span class="n">writeRaw</span><span class="p">(</span><span class="k">const</span> <span class="n">Poco</span><span class="o">::</span><span class="n">UInt8</span><span class="o">*</span> <span class="n">value</span><span class="p">,</span><span class="n">Poco</span><span class="o">::</span><span class="n">UInt32</span> <span class="n">size</span><span class="p">);</span>
    <span class="kt">void</span> <span class="n">writeRaw</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">value</span><span class="p">,</span><span class="n">Poco</span><span class="o">::</span><span class="n">UInt32</span> <span class="n">size</span><span class="p">);</span>
    <span class="kt">void</span> <span class="n">writeRaw</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">value</span><span class="p">);</span>
    <span class="kt">void</span> <span class="n">write8</span><span class="p">(</span><span class="n">Poco</span><span class="o">::</span><span class="n">UInt8</span> <span class="n">value</span><span class="p">);</span>
    <span class="kt">void</span> <span class="n">write16</span><span class="p">(</span><span class="n">Poco</span><span class="o">::</span><span class="n">UInt16</span> <span class="n">value</span><span class="p">);</span>
    <span class="kt">void</span> <span class="n">write32</span><span class="p">(</span><span class="n">Poco</span><span class="o">::</span><span class="n">UInt32</span> <span class="n">value</span><span class="p">);</span>
    <span class="kt">void</span> <span class="n">writeString8</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">value</span><span class="p">);</span>
    <span class="kt">void</span> <span class="n">writeString8</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">value</span><span class="p">,</span><span class="n">Poco</span><span class="o">::</span><span class="n">UInt8</span> <span class="n">size</span><span class="p">);</span>
    <span class="kt">void</span> <span class="n">writeString16</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">value</span><span class="p">);</span>
    <span class="kt">void</span> <span class="n">writeString16</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">value</span><span class="p">,</span><span class="n">Poco</span><span class="o">::</span><span class="n">UInt16</span> <span class="n">size</span><span class="p">);</span>
    <span class="kt">void</span> <span class="n">write7BitValue</span><span class="p">(</span><span class="n">Poco</span><span class="o">::</span><span class="n">UInt32</span> <span class="n">value</span><span class="p">);</span>
    <span class="kt">void</span> <span class="n">write7BitLongValue</span><span class="p">(</span><span class="n">Poco</span><span class="o">::</span><span class="n">UInt64</span> <span class="n">value</span><span class="p">);</span>
    <span class="kt">void</span> <span class="n">writeAddress</span><span class="p">(</span><span class="k">const</span> <span class="n">Address</span><span class="o">&amp;</span> <span class="n">address</span><span class="p">,</span><span class="kt">bool</span> <span class="n">publicFlag</span><span class="p">);</span>
    <span class="kt">void</span> <span class="n">writeAddress</span><span class="p">(</span><span class="k">const</span> <span class="n">Poco</span><span class="o">::</span><span class="n">Net</span><span class="o">::</span><span class="n">SocketAddress</span><span class="o">&amp;</span> <span class="n">address</span><span class="p">,</span><span class="kt">bool</span> <span class="n">publicFlag</span><span class="p">);</span>
    <span class="k">static</span> <span class="n">BinaryWriter</span> <span class="n">BinaryWriterNull</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div></div>

<p>请注意其中名为 <code class="language-plaintext highlighter-rouge">BinaryWriterNull</code> 的成员。构造函数定义为：</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">BinaryWriter</span><span class="o">::</span><span class="n">BinaryWriter</span><span class="p">(</span><span class="n">ostream</span><span class="o">&amp;</span> <span class="n">ostr</span><span class="p">)</span><span class="o">:</span>
    <span class="n">Poco</span><span class="o">::</span><span class="n">BinaryWriter</span><span class="p">(</span><span class="n">ostr</span><span class="p">,</span><span class="n">BinaryWriter</span><span class="o">::</span><span class="n">NETWORK_BYTE_ORDER</span><span class="p">)</span> <span class="p">{</span>
<span class="p">}</span>

<span class="n">BinaryWriter</span><span class="o">::~</span><span class="n">BinaryWriter</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">flush</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div>

<p>其中 <code class="language-plaintext highlighter-rouge">writeRaw</code> 是简单地封装 <code class="language-plaintext highlighter-rouge">Poco::BinaryWriter::writeRaw()</code>，如下：</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kr">inline</span> <span class="kt">void</span> <span class="n">BinaryWriter</span><span class="o">::</span><span class="n">writeRaw</span><span class="p">(</span><span class="k">const</span> <span class="n">Poco</span><span class="o">::</span><span class="n">UInt8</span><span class="o">*</span> <span class="n">value</span><span class="p">,</span><span class="n">Poco</span><span class="o">::</span><span class="n">UInt32</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Poco</span><span class="o">::</span><span class="n">BinaryWriter</span><span class="o">::</span><span class="n">writeRaw</span><span class="p">((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">value</span><span class="p">,</span><span class="n">size</span><span class="p">);</span>
<span class="p">}</span>
<span class="kr">inline</span> <span class="kt">void</span> <span class="n">BinaryWriter</span><span class="o">::</span><span class="n">writeRaw</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">value</span><span class="p">,</span><span class="n">Poco</span><span class="o">::</span><span class="n">UInt32</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Poco</span><span class="o">::</span><span class="n">BinaryWriter</span><span class="o">::</span><span class="n">writeRaw</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="n">size</span><span class="p">);</span>
<span class="p">}</span>
<span class="kr">inline</span> <span class="kt">void</span> <span class="n">BinaryWriter</span><span class="o">::</span><span class="n">writeRaw</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Poco</span><span class="o">::</span><span class="n">BinaryWriter</span><span class="o">::</span><span class="n">writeRaw</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>写入整数实现如下，用的是从 <code class="language-plaintext highlighter-rouge">Poco::BinaryReader</code> 继承来的重载运算符操作：</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kr">inline</span> <span class="kt">void</span> <span class="n">BinaryWriter</span><span class="o">::</span><span class="n">write8</span><span class="p">(</span><span class="n">Poco</span><span class="o">::</span><span class="n">UInt8</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>   
<span class="kr">inline</span> <span class="kt">void</span> <span class="n">BinaryWriter</span><span class="o">::</span><span class="n">write16</span><span class="p">(</span><span class="n">Poco</span><span class="o">::</span><span class="n">UInt16</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>
<span class="kr">inline</span> <span class="kt">void</span> <span class="n">BinaryWriter</span><span class="o">::</span><span class="n">write32</span><span class="p">(</span><span class="n">Poco</span><span class="o">::</span><span class="n">UInt32</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>写入字符串：</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="n">BinaryWriter</span><span class="o">::</span><span class="n">writeString8</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">value</span><span class="p">,</span><span class="n">UInt8</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">write8</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
    <span class="n">writeRaw</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="n">size</span><span class="p">);</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="n">BinaryWriter</span><span class="o">::</span><span class="n">writeString8</span><span class="p">(</span><span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">write8</span><span class="p">(</span><span class="n">value</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
    <span class="n">writeRaw</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="n">BinaryWriter</span><span class="o">::</span><span class="n">writeString16</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">value</span><span class="p">,</span><span class="n">UInt16</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">write16</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
    <span class="n">writeRaw</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="n">size</span><span class="p">);</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="n">BinaryWriter</span><span class="o">::</span><span class="n">writeString16</span><span class="p">(</span><span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">write16</span><span class="p">(</span><span class="n">value</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
    <span class="n">writeRaw</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>写入变长整数，这段代码含义也一目了然，就是读取变长无符号 32 位整数、64 位整数。</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="n">BinaryWriter</span><span class="o">::</span><span class="n">write7BitValue</span><span class="p">(</span><span class="n">UInt32</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">UInt8</span> <span class="n">shift</span> <span class="o">=</span> <span class="p">(</span><span class="n">Util</span><span class="o">::</span><span class="n">Get7BitValueSize</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">7</span><span class="p">;</span>
    <span class="kt">bool</span> <span class="n">max</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">shift</span><span class="o">&gt;=</span><span class="mi">21</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// 4 bytes maximum</span>
        <span class="n">shift</span> <span class="o">=</span> <span class="mi">22</span><span class="p">;</span>
        <span class="n">max</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span>
 
    <span class="k">while</span><span class="p">(</span><span class="n">shift</span><span class="o">&gt;=</span><span class="mi">7</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">write8</span><span class="p">(</span><span class="mh">0x80</span> <span class="o">|</span> <span class="p">((</span><span class="n">value</span><span class="o">&gt;&gt;</span><span class="n">shift</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0x7F</span><span class="p">));</span>
        <span class="n">shift</span> <span class="o">-=</span> <span class="mi">7</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">write8</span><span class="p">(</span><span class="n">max</span> <span class="o">?</span> <span class="n">value</span><span class="o">&amp;</span><span class="mh">0xFF</span> <span class="o">:</span> <span class="n">value</span><span class="o">&amp;</span><span class="mh">0x7F</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="n">BinaryWriter</span><span class="o">::</span><span class="n">write7BitLongValue</span><span class="p">(</span><span class="n">UInt64</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">UInt8</span> <span class="n">shift</span> <span class="o">=</span> <span class="p">(</span><span class="n">Util</span><span class="o">::</span><span class="n">Get7BitValueSize</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">7</span><span class="p">;</span>
    <span class="kt">bool</span> <span class="n">max</span> <span class="o">=</span> <span class="n">shift</span><span class="o">&gt;=</span><span class="mi">63</span><span class="p">;</span> <span class="c1">// Can give 10 bytes!</span>
    <span class="k">if</span><span class="p">(</span><span class="n">max</span><span class="p">)</span>
        <span class="o">++</span><span class="n">shift</span><span class="p">;</span>
 
    <span class="k">while</span><span class="p">(</span><span class="n">shift</span><span class="o">&gt;=</span><span class="mi">7</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">write8</span><span class="p">(</span><span class="mh">0x80</span> <span class="o">|</span> <span class="p">((</span><span class="n">value</span><span class="o">&gt;&gt;</span><span class="n">shift</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0x7F</span><span class="p">));</span>
        <span class="n">shift</span> <span class="o">-=</span> <span class="mi">7</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">write8</span><span class="p">(</span><span class="n">max</span> <span class="o">?</span> <span class="n">value</span><span class="o">&amp;</span><span class="mh">0xFF</span> <span class="o">:</span> <span class="n">value</span><span class="o">&amp;</span><span class="mh">0x7F</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>写入 IP 地址的两个函数暂略。</p>

<h4 id="3反序列化">3、反序列化</h4>

<p>反序列化就是从指定格式的数据中读出各类型的数据值。</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">BinaryReader</span> <span class="o">:</span> <span class="k">public</span> <span class="n">Poco</span><span class="o">::</span><span class="n">BinaryReader</span> <span class="p">{</span>
<span class="nl">public:</span>
    <span class="n">BinaryReader</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">istream</span><span class="o">&amp;</span> <span class="n">istr</span><span class="p">);</span>
    <span class="k">virtual</span> <span class="o">~</span><span class="n">BinaryReader</span><span class="p">();</span>
 
    <span class="n">Poco</span><span class="o">::</span><span class="n">UInt32</span>    <span class="n">read7BitValue</span><span class="p">();</span>
    <span class="n">Poco</span><span class="o">::</span><span class="n">UInt64</span>    <span class="n">read7BitLongValue</span><span class="p">();</span>
    <span class="n">Poco</span><span class="o">::</span><span class="n">UInt32</span>    <span class="n">read7BitEncoded</span><span class="p">();</span>
    <span class="kt">void</span>            <span class="n">readString</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">value</span><span class="p">);</span>
    <span class="kt">void</span>            <span class="n">readRaw</span><span class="p">(</span><span class="n">Poco</span><span class="o">::</span><span class="n">UInt8</span><span class="o">*</span> <span class="n">value</span><span class="p">,</span><span class="n">Poco</span><span class="o">::</span><span class="n">UInt32</span> <span class="n">size</span><span class="p">);</span>
    <span class="kt">void</span>            <span class="n">readRaw</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">value</span><span class="p">,</span><span class="n">Poco</span><span class="o">::</span><span class="n">UInt32</span> <span class="n">size</span><span class="p">);</span>
    <span class="kt">void</span>            <span class="n">readRaw</span><span class="p">(</span><span class="n">Poco</span><span class="o">::</span><span class="n">UInt32</span> <span class="n">size</span><span class="p">,</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">value</span><span class="p">);</span>
    <span class="kt">void</span>            <span class="n">readString8</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">value</span><span class="p">);</span>
    <span class="kt">void</span>            <span class="n">readString16</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">value</span><span class="p">);</span>
    <span class="n">Poco</span><span class="o">::</span><span class="n">UInt8</span>     <span class="n">read8</span><span class="p">();</span>
    <span class="n">Poco</span><span class="o">::</span><span class="n">UInt16</span>    <span class="n">read16</span><span class="p">();</span>
    <span class="n">Poco</span><span class="o">::</span><span class="n">UInt32</span>    <span class="n">read32</span><span class="p">();</span>
    <span class="kt">bool</span>            <span class="n">readAddress</span><span class="p">(</span><span class="n">Address</span><span class="o">&amp;</span> <span class="n">address</span><span class="p">);</span>
 
    <span class="k">static</span> <span class="n">BinaryReader</span> <span class="n">BinaryReaderNull</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div></div>

<p>构造与析构函数都很简单：</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">BinaryReader</span><span class="o">::</span><span class="n">BinaryReader</span><span class="p">(</span><span class="n">istream</span><span class="o">&amp;</span> <span class="n">istr</span><span class="p">)</span> <span class="o">:</span> <span class="n">Poco</span><span class="o">::</span><span class="n">BinaryReader</span><span class="p">(</span><span class="n">istr</span><span class="p">,</span><span class="n">BinaryReader</span><span class="o">::</span><span class="n">NETWORK_BYTE_ORDER</span><span class="p">)</span> <span class="p">{</span>
<span class="p">}</span>
 
<span class="n">BinaryReader</span><span class="o">::~</span><span class="n">BinaryReader</span><span class="p">()</span> <span class="p">{</span>
<span class="p">}</span>
</code></pre></div></div>

<p>读取原生数据（Raw Data）：</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kr">inline</span> <span class="kt">void</span> <span class="n">BinaryReader</span><span class="o">::</span><span class="n">readRaw</span><span class="p">(</span><span class="n">Poco</span><span class="o">::</span><span class="n">UInt8</span><span class="o">*</span> <span class="n">value</span><span class="p">,</span><span class="n">Poco</span><span class="o">::</span><span class="n">UInt32</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Poco</span><span class="o">::</span><span class="n">BinaryReader</span><span class="o">::</span><span class="n">readRaw</span><span class="p">((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">value</span><span class="p">,</span><span class="n">size</span><span class="p">);</span>
<span class="p">}</span>
<span class="kr">inline</span> <span class="kt">void</span> <span class="n">BinaryReader</span><span class="o">::</span><span class="n">readRaw</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">value</span><span class="p">,</span><span class="n">Poco</span><span class="o">::</span><span class="n">UInt32</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Poco</span><span class="o">::</span><span class="n">BinaryReader</span><span class="o">::</span><span class="n">readRaw</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="n">size</span><span class="p">);</span>
<span class="p">}</span>
<span class="kr">inline</span> <span class="kt">void</span> <span class="n">BinaryReader</span><span class="o">::</span><span class="n">readRaw</span><span class="p">(</span><span class="n">Poco</span><span class="o">::</span><span class="n">UInt32</span> <span class="n">size</span><span class="p">,</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Poco</span><span class="o">::</span><span class="n">BinaryReader</span><span class="o">::</span><span class="n">readRaw</span><span class="p">(</span><span class="n">size</span><span class="p">,</span><span class="n">value</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>写整数，用的是 <code class="language-plaintext highlighter-rouge">Poco::BinaryWriter</code> 的重载运算符：</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kr">inline</span> <span class="kt">void</span> <span class="n">BinaryWriter</span><span class="o">::</span><span class="n">write8</span><span class="p">(</span><span class="n">Poco</span><span class="o">::</span><span class="n">UInt8</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>
 
<span class="kr">inline</span> <span class="kt">void</span> <span class="n">BinaryWriter</span><span class="o">::</span><span class="n">write16</span><span class="p">(</span><span class="n">Poco</span><span class="o">::</span><span class="n">UInt16</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>
 
<span class="kr">inline</span> <span class="kt">void</span> <span class="n">BinaryWriter</span><span class="o">::</span><span class="n">write32</span><span class="p">(</span><span class="n">Poco</span><span class="o">::</span><span class="n">UInt32</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>读写整数依旧使用从 <code class="language-plaintext highlighter-rouge">Poco::BinaryReader</code> 继承来的运算符操作：</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">UInt8</span> <span class="n">BinaryReader</span><span class="o">::</span><span class="n">read8</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">UInt8</span> <span class="n">c</span><span class="p">;</span>
    <span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">c</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">c</span><span class="p">;</span>
<span class="p">}</span>
 
<span class="n">UInt16</span> <span class="n">BinaryReader</span><span class="o">::</span><span class="n">read16</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">UInt16</span> <span class="n">c</span><span class="p">;</span>
    <span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">c</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">c</span><span class="p">;</span>
<span class="p">}</span>
 
<span class="n">UInt32</span> <span class="n">BinaryReader</span><span class="o">::</span><span class="n">read32</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">UInt32</span> <span class="n">c</span><span class="p">;</span>
    <span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">c</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">c</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>写字符串：</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="n">BinaryWriter</span><span class="o">::</span><span class="n">writeString8</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">value</span><span class="p">,</span><span class="n">UInt8</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">write8</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
    <span class="n">writeRaw</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="n">size</span><span class="p">);</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="n">BinaryWriter</span><span class="o">::</span><span class="n">writeString8</span><span class="p">(</span><span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">write8</span><span class="p">(</span><span class="n">value</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
    <span class="n">writeRaw</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="n">BinaryWriter</span><span class="o">::</span><span class="n">writeString16</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">value</span><span class="p">,</span><span class="n">UInt16</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">write16</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
    <span class="n">writeRaw</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="n">size</span><span class="p">);</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="n">BinaryWriter</span><span class="o">::</span><span class="n">writeString16</span><span class="p">(</span><span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">write16</span><span class="p">(</span><span class="n">value</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
    <span class="n">writeRaw</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>读取变长整数，分别针对 <code class="language-plaintext highlighter-rouge">UInt32</code> 和 <code class="language-plaintext highlighter-rouge">UInt64</code>，要理解 <code class="language-plaintext highlighter-rouge">AMF3</code> 的变长整数才能理解这个：</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">UInt32</span> <span class="n">BinaryReader</span><span class="o">::</span><span class="n">read7BitValue</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">UInt8</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">UInt8</span> <span class="n">b</span> <span class="o">=</span> <span class="n">read8</span><span class="p">();</span>
    <span class="n">UInt32</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">((</span><span class="n">b</span><span class="o">&amp;</span><span class="mh">0x80</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">result</span> <span class="o">&lt;&lt;=</span> <span class="mi">7</span><span class="p">;</span>
        <span class="n">result</span> <span class="o">|=</span> <span class="p">(</span><span class="n">b</span><span class="o">&amp;</span><span class="mh">0x7F</span><span class="p">);</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">read8</span><span class="p">();</span>
        <span class="o">++</span><span class="n">n</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">result</span> <span class="o">&lt;&lt;=</span> <span class="p">((</span><span class="n">n</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">)</span> <span class="o">?</span> <span class="mi">7</span> <span class="o">:</span> <span class="mi">8</span><span class="p">);</span> <span class="c1">// Use all 8 bits from the 4th byte</span>
    <span class="n">result</span> <span class="o">|=</span> <span class="n">b</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">UInt64</span> <span class="n">BinaryReader</span><span class="o">::</span><span class="n">read7BitLongValue</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">UInt8</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">UInt8</span> <span class="n">b</span> <span class="o">=</span> <span class="n">read8</span><span class="p">();</span>
    <span class="n">UInt64</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">((</span><span class="n">b</span><span class="o">&amp;</span><span class="mh">0x80</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">result</span> <span class="o">&lt;&lt;=</span> <span class="mi">7</span><span class="p">;</span>
        <span class="n">result</span> <span class="o">|=</span> <span class="p">(</span><span class="n">b</span><span class="o">&amp;</span><span class="mh">0x7F</span><span class="p">);</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">read8</span><span class="p">();</span>
        <span class="o">++</span><span class="n">n</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">result</span> <span class="o">&lt;&lt;=</span> <span class="p">((</span><span class="n">n</span><span class="o">&lt;</span><span class="mi">8</span><span class="p">)</span> <span class="o">?</span> <span class="mi">7</span> <span class="o">:</span> <span class="mi">8</span><span class="p">);</span> <span class="c1">// Use all 8 bits from the 4th byte</span>
    <span class="n">result</span> <span class="o">|=</span> <span class="n">b</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="三packetreaderwriter">三、<code class="language-plaintext highlighter-rouge">PacketReader/Writer</code></h3>

<h4 id="1packetreader">1、PacketReader</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#define PACKETRECV_SIZE     2048
class PacketReader: public BinaryReader {
public:
    PacketReader(const Poco::UInt8* buffer,Poco::UInt32 size);
    PacketReader(PacketReader&amp;);
    virtual ~PacketReader();
    const Poco::UInt32  fragments;
    Poco::UInt32    available(); // 可读字节数
    Poco::UInt8*    current();
    Poco::UInt32    position(); // 获取当前的相对位置（相对于起始位置的）
    void            reset(Poco::UInt32 newPos = 0); // 设定当前位置
    void            shrink(Poco::UInt32 rest);
    void            next(Poco::UInt32 size);
private:
    MemoryInputStream _memory;
};
</code></pre></div></div>

<h6 id="11封装-memoryinputstream">1.1、封装 <code class="language-plaintext highlighter-rouge">MemoryInputStream</code></h6>

<p><code class="language-plaintext highlighter-rouge">available</code></p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kr">inline</span> <span class="n">Poco</span><span class="o">::</span><span class="n">UInt32</span> <span class="n">PacketReader</span><span class="o">::</span><span class="n">available</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="n">_memory</span><span class="p">.</span><span class="n">available</span><span class="p">();</span>
  <span class="p">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">current</code>：当前绝对位置（内存地址）</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kr">inline</span> <span class="n">Poco</span><span class="o">::</span><span class="n">UInt8</span><span class="o">*</span> <span class="n">PacketReader</span><span class="o">::</span><span class="n">current</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="p">(</span><span class="n">Poco</span><span class="o">::</span><span class="n">UInt8</span><span class="o">*</span><span class="p">)</span><span class="n">_memory</span><span class="p">.</span><span class="n">current</span><span class="p">();</span>
  <span class="p">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">position</code>：当前位置（绝对位置）减去缓冲区起始位置</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kr">inline</span> <span class="n">Poco</span><span class="o">::</span><span class="n">UInt32</span> <span class="n">PacketReader</span><span class="o">::</span><span class="n">position</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="n">_memory</span><span class="p">.</span><span class="n">current</span><span class="p">()</span> <span class="o">-</span> <span class="n">_memory</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
  <span class="p">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">reset</code></p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kr">inline</span> <span class="kt">void</span> <span class="n">PacketReader</span><span class="o">::</span><span class="n">reset</span><span class="p">(</span><span class="n">Poco</span><span class="o">::</span><span class="n">UInt32</span> <span class="n">newPos</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">_memory</span><span class="p">.</span><span class="n">reset</span><span class="p">(</span><span class="n">newPos</span><span class="p">);</span>
  <span class="p">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">next</code></p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kr">inline</span> <span class="kt">void</span> <span class="n">PacketReader</span><span class="o">::</span><span class="n">next</span><span class="p">(</span><span class="n">Poco</span><span class="o">::</span><span class="n">UInt32</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="n">_memory</span><span class="p">.</span><span class="n">next</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
  <span class="p">}</span>
</code></pre></div></div>

<h6 id="12收缩缓冲区">1.2、收缩缓冲区</h6>

<p>封装了 <code class="language-plaintext highlighter-rouge">MemoryInputStream</code> 的 <code class="language-plaintext highlighter-rouge">resize</code>。不过由于前面的 <code class="language-plaintext highlighter-rouge">if</code> 语句影响，传给 resize 的参数一定不会大于缓冲区的当前大小。</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="n">PacketReader</span><span class="o">::</span><span class="n">shrink</span><span class="p">(</span><span class="n">UInt32</span> <span class="n">rest</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">rest</span> <span class="o">&gt;</span> <span class="n">available</span><span class="p">())</span> <span class="p">{</span>
        <span class="n">WARN</span><span class="p">(</span><span class="s">"rest %u more upper than available %u bytes"</span><span class="p">,</span><span class="n">rest</span><span class="p">,</span><span class="n">available</span><span class="p">());</span>
        <span class="n">rest</span> <span class="o">=</span> <span class="n">available</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="n">_memory</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">position</span><span class="p">()</span> <span class="o">+</span> <span class="n">rest</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<h6 id="13构造函数拷贝构造函数和析构函数">1.3、构造函数、拷贝构造函数和析构函数</h6>

<p>构造函数先调用父类 <code class="language-plaintext highlighter-rouge">BinaryReader</code> 的构造函数，并初始化 <code class="language-plaintext highlighter-rouge">fragments</code> 和 <code class="language-plaintext highlighter-rouge">_memory</code> 输入流的缓冲区。</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">PacketReader</span><span class="o">::</span><span class="n">PacketReader</span><span class="p">(</span><span class="k">const</span> <span class="n">UInt8</span><span class="o">*</span> <span class="n">buffer</span><span class="p">,</span><span class="n">UInt32</span> <span class="n">size</span><span class="p">)</span>
    <span class="o">:</span> <span class="n">_memory</span><span class="p">((</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">buffer</span><span class="p">,</span> <span class="n">size</span><span class="p">),</span>
      <span class="n">BinaryReader</span><span class="p">(</span><span class="n">_memory</span><span class="p">),</span>
      <span class="n">fragments</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
<span class="p">}</span>
 
<span class="c1">// Consctruction by copy</span>
<span class="n">PacketReader</span><span class="o">::</span><span class="n">PacketReader</span><span class="p">(</span><span class="n">PacketReader</span><span class="o">&amp;</span> <span class="n">other</span><span class="p">)</span>
    <span class="o">:</span> <span class="n">_memory</span><span class="p">(</span><span class="n">other</span><span class="p">.</span><span class="n">_memory</span><span class="p">),</span>
      <span class="n">BinaryReader</span><span class="p">(</span><span class="n">_memory</span><span class="p">),</span>
      <span class="n">fragments</span><span class="p">(</span><span class="n">other</span><span class="p">.</span><span class="n">fragments</span><span class="p">)</span> <span class="p">{</span>
<span class="p">}</span>
 
<span class="n">PacketReader</span><span class="o">::~</span><span class="n">PacketReader</span><span class="p">()</span> <span class="p">{</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="2packetwriter">2、<code class="language-plaintext highlighter-rouge">PacketWriter</code></h4>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">PacketWriter</span><span class="o">:</span> <span class="k">public</span> <span class="n">BinaryWriter</span> <span class="p">{</span>
<span class="nl">public:</span>
    <span class="n">PacketWriter</span><span class="p">(</span><span class="k">const</span> <span class="n">Poco</span><span class="o">::</span><span class="n">UInt8</span><span class="o">*</span> <span class="n">buffer</span><span class="p">,</span><span class="n">Poco</span><span class="o">::</span><span class="n">UInt32</span> <span class="n">size</span><span class="p">);</span>
    <span class="n">PacketWriter</span><span class="p">(</span><span class="n">PacketWriter</span><span class="o">&amp;</span><span class="p">);</span>
    <span class="k">virtual</span> <span class="o">~</span><span class="n">PacketWriter</span><span class="p">();</span>
    <span class="n">Poco</span><span class="o">::</span><span class="n">UInt8</span><span class="o">*</span>        <span class="n">begin</span><span class="p">();</span>
    <span class="n">Poco</span><span class="o">::</span><span class="n">UInt32</span>        <span class="n">length</span><span class="p">();</span>
    <span class="n">Poco</span><span class="o">::</span><span class="n">UInt32</span>        <span class="n">position</span><span class="p">();</span>
    <span class="n">Poco</span><span class="o">::</span><span class="n">UInt32</span>        <span class="n">available</span><span class="p">();</span>
    <span class="kt">bool</span>    <span class="n">good</span><span class="p">();</span>
    <span class="kt">void</span>    <span class="n">clear</span><span class="p">(</span><span class="n">Poco</span><span class="o">::</span><span class="n">UInt32</span> <span class="n">pos</span><span class="o">=</span><span class="mi">0</span><span class="p">);</span>
    <span class="kt">void</span>    <span class="n">reset</span><span class="p">(</span><span class="n">Poco</span><span class="o">::</span><span class="n">UInt32</span> <span class="n">newPos</span><span class="p">);</span>
    <span class="kt">void</span>    <span class="n">limit</span><span class="p">(</span><span class="n">Poco</span><span class="o">::</span><span class="n">UInt32</span> <span class="n">length</span><span class="o">=</span><span class="mi">0</span><span class="p">);</span>
    <span class="kt">void</span>    <span class="n">next</span><span class="p">(</span><span class="n">Poco</span><span class="o">::</span><span class="n">UInt32</span> <span class="n">size</span><span class="p">);</span>
    <span class="kt">void</span>    <span class="n">flush</span><span class="p">();</span>
<span class="nl">private:</span>
    <span class="n">MemoryOutputStream</span>  <span class="n">_memory</span><span class="p">;</span>
    <span class="n">PacketWriter</span><span class="o">*</span>       <span class="n">_pOther</span><span class="p">;</span>
    <span class="n">Poco</span><span class="o">::</span><span class="n">UInt32</span>        <span class="n">_size</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div></div>

<h6 id="21封装memoryoutputstream">2.1、封装<code class="language-plaintext highlighter-rouge">MemoryOutputStream</code></h6>

<p><code class="language-plaintext highlighter-rouge">available</code></p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kr">inline</span> <span class="n">Poco</span><span class="o">::</span><span class="n">UInt32</span> <span class="n">PacketWriter</span><span class="o">::</span><span class="n">available</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="n">_memory</span><span class="p">.</span><span class="n">available</span><span class="p">();</span>
  <span class="p">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">good</code>：不过 <code class="language-plaintext highlighter-rouge">MemoryOutputStream</code> 也是封装的 <code class="language-plaintext highlighter-rouge">std::ostream</code> 的 <code class="language-plaintext highlighter-rouge">good</code> 函数，True if no error flags are set.</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kr">inline</span> <span class="kt">bool</span> <span class="n">PacketWriter</span><span class="o">::</span><span class="n">good</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="n">_memory</span><span class="p">.</span><span class="n">good</span><span class="p">();</span>
  <span class="p">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">written</code></p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kr">inline</span> <span class="n">Poco</span><span class="o">::</span><span class="n">UInt32</span> <span class="n">PacketWriter</span><span class="o">::</span><span class="n">length</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="n">_memory</span><span class="p">.</span><span class="n">written</span><span class="p">();</span>
  <span class="p">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">position</code></p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kr">inline</span> <span class="n">Poco</span><span class="o">::</span><span class="n">UInt32</span> <span class="n">PacketWriter</span><span class="o">::</span><span class="n">position</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="n">_memory</span><span class="p">.</span><span class="n">current</span><span class="p">()</span><span class="o">-</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">begin</span><span class="p">();</span>
  <span class="p">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">reset</code>：设置缓冲区的指针位置，即 <code class="language-plaintext highlighter-rouge">position</code></p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kr">inline</span> <span class="kt">void</span> <span class="n">PacketWriter</span><span class="o">::</span><span class="n">reset</span><span class="p">(</span><span class="n">Poco</span><span class="o">::</span><span class="n">UInt32</span> <span class="n">newPos</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">_memory</span><span class="p">.</span><span class="n">reset</span><span class="p">(</span><span class="n">newPos</span><span class="p">);</span>
  <span class="p">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">next</code>：移动缓冲区指针</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kr">inline</span> <span class="kt">void</span> <span class="n">PacketWriter</span><span class="o">::</span><span class="n">next</span><span class="p">(</span><span class="n">Poco</span><span class="o">::</span><span class="n">UInt32</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="n">_memory</span><span class="p">.</span><span class="n">next</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
  <span class="p">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">begin</code>：返回缓冲区的起始地址</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kr">inline</span> <span class="n">Poco</span><span class="o">::</span><span class="n">UInt8</span><span class="o">*</span> <span class="n">PacketWriter</span><span class="o">::</span><span class="n">begin</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="p">(</span><span class="n">Poco</span><span class="o">::</span><span class="n">UInt8</span><span class="o">*</span><span class="p">)</span><span class="n">_memory</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
  <span class="p">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">clear</code>：其实就是修改 written 和 position，使得指定位置后面的数据在以后写的时候可以被覆盖，并不是真正的清除。</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kt">void</span> <span class="n">PacketWriter</span><span class="o">::</span><span class="n">clear</span><span class="p">(</span><span class="n">UInt32</span> <span class="n">pos</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">reset</span><span class="p">(</span><span class="n">pos</span><span class="p">);</span>
      <span class="n">_memory</span><span class="p">.</span><span class="n">written</span><span class="p">(</span><span class="n">pos</span><span class="p">);</span>
  <span class="p">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">limit</code>：封装 <code class="language-plaintext highlighter-rouge">MemoryOutputStream</code> 的 <code class="language-plaintext highlighter-rouge">resize</code></p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kt">void</span> <span class="n">PacketWriter</span><span class="o">::</span><span class="n">limit</span><span class="p">(</span><span class="n">UInt32</span> <span class="n">length</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
          <span class="n">length</span> <span class="o">=</span> <span class="n">_size</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">&gt;</span> <span class="n">_size</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">WARN</span><span class="p">(</span><span class="s">"Limit '%d' more upper than buffer size '%d' bytes"</span><span class="p">,</span><span class="n">length</span><span class="p">,</span><span class="n">_size</span><span class="p">);</span>
          <span class="n">length</span> <span class="o">=</span> <span class="n">_size</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="n">_memory</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">length</span><span class="p">);</span>
  <span class="p">}</span>
</code></pre></div></div>

<h6 id="22封装-binarywriter">2.2、封装 <code class="language-plaintext highlighter-rouge">BinaryWriter</code></h6>

<p><code class="language-plaintext highlighter-rouge">flush</code>：封装 <code class="language-plaintext highlighter-rouge">BinaryWriter</code> 的 <code class="language-plaintext highlighter-rouge">flush</code>，不过 <code class="language-plaintext highlighter-rouge">BinaryWriter</code> 的 <code class="language-plaintext highlighter-rouge">flush</code> 实际上是从 <code class="language-plaintext highlighter-rouge">Poco::BinaryWriter</code> 继承而来的。其作用是「Flushes the underlying stream」。</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kt">void</span> <span class="n">PacketWriter</span><span class="o">::</span><span class="n">flush</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">_pOther</span> <span class="o">&amp;&amp;</span> <span class="n">_memory</span><span class="p">.</span><span class="n">written</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">_pOther</span><span class="o">-&gt;</span><span class="n">_memory</span><span class="p">.</span><span class="n">written</span><span class="p">())</span>
          <span class="n">_pOther</span><span class="o">-&gt;</span><span class="n">_memory</span><span class="p">.</span><span class="n">written</span><span class="p">(</span><span class="n">_memory</span><span class="p">.</span><span class="n">written</span><span class="p">());</span>
      <span class="n">BinaryWriter</span><span class="o">::</span><span class="n">flush</span><span class="p">();</span>
  <span class="p">}</span>
</code></pre></div></div>

<h6 id="23构造函数拷贝构造函数和析构函数">2.3、构造函数、拷贝构造函数和析构函数</h6>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">PacketWriter</span><span class="o">::</span><span class="n">PacketWriter</span><span class="p">(</span><span class="k">const</span> <span class="n">UInt8</span><span class="o">*</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">UInt32</span> <span class="n">size</span><span class="p">)</span>
    <span class="o">:</span> <span class="n">_memory</span><span class="p">((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">buffer</span><span class="p">,</span> <span class="n">size</span><span class="p">),</span>
      <span class="n">BinaryWriter</span><span class="p">(</span><span class="n">_memory</span><span class="p">),</span>
      <span class="n">_pOther</span><span class="p">(</span><span class="nb">NULL</span><span class="p">),</span>
      <span class="n">_size</span><span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
<span class="p">}</span>
 
<span class="c1">// Consctruction by copy</span>
<span class="n">PacketWriter</span><span class="o">::</span><span class="n">PacketWriter</span><span class="p">(</span><span class="n">PacketWriter</span><span class="o">&amp;</span> <span class="n">other</span><span class="p">)</span>
    <span class="o">:</span> <span class="n">_pOther</span><span class="p">(</span><span class="o">&amp;</span><span class="n">other</span><span class="p">),</span>
      <span class="n">_memory</span><span class="p">(</span><span class="n">other</span><span class="p">.</span><span class="n">_memory</span><span class="p">),</span>
      <span class="n">BinaryWriter</span><span class="p">(</span><span class="n">_memory</span><span class="p">),</span>
      <span class="n">_size</span><span class="p">(</span><span class="n">other</span><span class="p">.</span><span class="n">_size</span><span class="p">)</span> <span class="p">{</span>
<span class="p">}</span>
</code></pre></div></div>

<p>注意析构函数中会进行 <code class="language-plaintext highlighter-rouge">flush</code>：</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">PacketWriter</span><span class="o">::~</span><span class="n">PacketWriter</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">flush</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="四amfreader">四、<code class="language-plaintext highlighter-rouge">AMFReader</code></h3>

<h4 id="1objectdef">1、<code class="language-plaintext highlighter-rouge">ObjectDef</code></h4>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ObjectDef</span> <span class="p">{</span>
<span class="nl">public:</span> 
    <span class="n">ObjectDef</span><span class="p">(</span><span class="n">UInt32</span> <span class="n">amf3</span><span class="p">,</span><span class="n">UInt8</span> <span class="n">arrayType</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="o">:</span> <span class="n">amf3</span><span class="p">(</span><span class="n">amf3</span><span class="p">),</span>
          <span class="n">reset</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
          <span class="n">dynamic</span><span class="p">(</span><span class="nb">false</span><span class="p">),</span>
          <span class="n">externalizable</span><span class="p">(</span><span class="nb">false</span><span class="p">),</span>
          <span class="n">count</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
          <span class="n">arrayType</span><span class="p">(</span><span class="n">arrayType</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">}</span>
 
    <span class="n">list</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;</span>    <span class="n">hardProperties</span><span class="p">;</span>
    <span class="n">UInt32</span>          <span class="n">reset</span><span class="p">;</span>
    <span class="kt">bool</span>            <span class="n">dynamic</span><span class="p">;</span>
    <span class="kt">bool</span>            <span class="n">externalizable</span><span class="p">;</span>
    <span class="n">UInt32</span>          <span class="n">count</span><span class="p">;</span>
    <span class="n">UInt8</span>           <span class="n">arrayType</span><span class="p">;</span>
    <span class="k">const</span> <span class="n">UInt32</span>    <span class="n">amf3</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div></div>

<h4 id="2amfreader-定义">2、<code class="language-plaintext highlighter-rouge">AMFReader</code> 定义</h4>

<p>其中 <code class="language-plaintext highlighter-rouge">PacketReader</code> 作为其成员。</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">AMFReader</span> <span class="p">{</span>
<span class="nl">public:</span>
    <span class="n">AMFReader</span><span class="p">(</span><span class="n">PacketReader</span><span class="o">&amp;</span> <span class="n">reader</span><span class="p">);</span>
    <span class="o">~</span><span class="n">AMFReader</span><span class="p">();</span>
 
    <span class="kt">void</span>            <span class="n">readSimpleObject</span><span class="p">(</span><span class="n">AMFSimpleObject</span><span class="o">&amp;</span> <span class="n">object</span><span class="p">);</span>
 
    <span class="kt">void</span>            <span class="n">read</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">value</span><span class="p">);</span>
    <span class="kt">double</span>          <span class="n">readNumber</span><span class="p">();</span>
    <span class="n">Poco</span><span class="o">::</span><span class="n">Int32</span>     <span class="n">readInteger</span><span class="p">();</span>
    <span class="kt">bool</span>            <span class="n">readBoolean</span><span class="p">();</span>
    <span class="n">BinaryReader</span><span class="o">&amp;</span>   <span class="n">readByteArray</span><span class="p">(</span><span class="n">Poco</span><span class="o">::</span><span class="n">UInt32</span><span class="o">&amp;</span> <span class="n">size</span><span class="p">);</span>
    <span class="n">Poco</span><span class="o">::</span><span class="n">Timestamp</span> <span class="n">readDate</span><span class="p">();</span>
 
    <span class="kt">bool</span>            <span class="n">readObject</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">type</span><span class="p">);</span>
    <span class="kt">bool</span>            <span class="n">readArray</span><span class="p">();</span>
    <span class="kt">bool</span>            <span class="n">readDictionary</span><span class="p">(</span><span class="kt">bool</span><span class="o">&amp;</span> <span class="n">weakKeys</span><span class="p">);</span>
    <span class="n">AMF</span><span class="o">::</span><span class="n">Type</span>       <span class="n">readKey</span><span class="p">();</span>
    <span class="n">AMF</span><span class="o">::</span><span class="n">Type</span>       <span class="n">readValue</span><span class="p">();</span>
    <span class="n">AMF</span><span class="o">::</span><span class="n">Type</span>       <span class="n">readItem</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">name</span><span class="p">);</span>
    <span class="n">BinaryReader</span><span class="o">&amp;</span>   <span class="n">readRawObjectContent</span><span class="p">();</span>
 
    <span class="kt">void</span>            <span class="n">readNull</span><span class="p">();</span>
    <span class="n">AMF</span><span class="o">::</span><span class="n">Type</span>       <span class="n">followingType</span><span class="p">();</span>
 
    <span class="kt">bool</span>            <span class="n">available</span><span class="p">();</span>
 
    <span class="kt">void</span>            <span class="n">startReferencing</span><span class="p">();</span>
    <span class="kt">void</span>            <span class="n">stopReferencing</span><span class="p">();</span>
 
    <span class="n">PacketReader</span><span class="o">&amp;</span>   <span class="n">reader</span><span class="p">;</span>
 
<span class="nl">private:</span>
    <span class="kt">void</span>                            <span class="n">readString</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">value</span><span class="p">);</span>
    <span class="n">Poco</span><span class="o">::</span><span class="n">UInt8</span>                     <span class="n">current</span><span class="p">();</span>
    <span class="kt">void</span>                            <span class="n">reset</span><span class="p">();</span>
    <span class="n">std</span><span class="o">::</span><span class="n">list</span><span class="o">&lt;</span><span class="n">ObjectDef</span><span class="o">*&gt;</span>           <span class="n">_objectDefs</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Poco</span><span class="o">::</span><span class="n">UInt32</span><span class="o">&gt;</span>       <span class="n">_stringReferences</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Poco</span><span class="o">::</span><span class="n">UInt32</span><span class="o">&gt;</span>       <span class="n">_classDefReferences</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Poco</span><span class="o">::</span><span class="n">UInt32</span><span class="o">&gt;</span>       <span class="n">_references</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Poco</span><span class="o">::</span><span class="n">UInt32</span><span class="o">&gt;</span>       <span class="n">_amf0References</span><span class="p">;</span>
    <span class="n">Poco</span><span class="o">::</span><span class="n">UInt32</span>                    <span class="n">_amf0Reset</span><span class="p">;</span>
    <span class="n">Poco</span><span class="o">::</span><span class="n">UInt32</span>                    <span class="n">_reset</span><span class="p">;</span>
    <span class="n">Poco</span><span class="o">::</span><span class="n">UInt32</span>                    <span class="n">_amf3</span><span class="p">;</span>
    <span class="kt">bool</span>                            <span class="n">_referencing</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div></div>

<h5 id="21构造函数析构函数">2.1、构造函数、析构函数</h5>

<p>参数为 <code class="language-plaintext highlighter-rouge">PacketReader</code>，会初始化一些成员变量。</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">AMFReader</span><span class="o">::</span><span class="n">AMFReader</span><span class="p">(</span><span class="n">PacketReader</span><span class="o">&amp;</span> <span class="n">reader</span><span class="p">)</span>
    <span class="o">:</span> <span class="n">reader</span><span class="p">(</span><span class="n">reader</span><span class="p">),</span>
      <span class="n">_reset</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
      <span class="n">_amf3</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
      <span class="n">_amf0Reset</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
      <span class="n">_referencing</span><span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
<span class="p">}</span>
</code></pre></div></div>

<p>析构时，会逐一释放 <code class="language-plaintext highlighter-rouge">_objectDefs</code> 中对象的内存：</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">AMFReader</span><span class="o">::~</span><span class="n">AMFReader</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">list</span><span class="o">&lt;</span><span class="n">ObjectDef</span><span class="o">*&gt;::</span><span class="n">iterator</span> <span class="n">it</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">it</span> <span class="o">=</span> <span class="n">_objectDefs</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span> <span class="n">it</span><span class="o">!=</span><span class="n">_objectDefs</span><span class="p">.</span><span class="n">end</span><span class="p">();</span> <span class="o">++</span><span class="n">it</span><span class="p">)</span>
        <span class="k">delete</span> <span class="o">*</span><span class="n">it</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h5 id="22简单封装-packetreader-的一些函数">2.2、简单封装 <code class="language-plaintext highlighter-rouge">PacketReader</code> 的一些函数</h5>

<p><code class="language-plaintext highlighter-rouge">reset</code>：操作指针位置</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kt">void</span> <span class="n">AMFReader</span><span class="o">::</span><span class="n">reset</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">_reset</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">reader</span><span class="p">.</span><span class="n">reset</span><span class="p">(</span><span class="n">_reset</span><span class="p">);</span>
          <span class="n">_reset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="p">}</span>
  <span class="p">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">available</code>：根据当前缓冲区大小和 <code class="language-plaintext highlighter-rouge">written</code> 计算得到</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kt">bool</span> <span class="n">AMFReader</span><span class="o">::</span><span class="n">available</span><span class="p">()</span> <span class="p">{</span>
      <span class="n">reset</span><span class="p">();</span>
      <span class="k">return</span> <span class="n">reader</span><span class="p">.</span><span class="n">available</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">current</code>：<code class="language-plaintext highlighter-rouge">gptr</code> 内存地址</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kr">inline</span> <span class="n">Poco</span><span class="o">::</span><span class="n">UInt8</span> <span class="n">AMFReader</span><span class="o">::</span><span class="n">current</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="o">*</span><span class="n">reader</span><span class="p">.</span><span class="n">current</span><span class="p">();</span>
  <span class="p">}</span>
</code></pre></div></div>

<h5 id="23设置-gptr-位置">2.3、设置 <code class="language-plaintext highlighter-rouge">gptr</code> 位置</h5>

<p>其实 <code class="language-plaintext highlighter-rouge">pptr</code> 也被影响了，但是在 <code class="language-plaintext highlighter-rouge">AMFReader</code> 中只用 <code class="language-plaintext highlighter-rouge">gptr</code>。调用构造函数的时候，<code class="language-plaintext highlighter-rouge">reset</code> 被设为 0，其后在每次读取数据的时候都会影响 <code class="language-plaintext highlighter-rouge">reset</code>。</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="n">AMFReader</span><span class="o">::</span><span class="n">reset</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">_reset</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">reader</span><span class="p">.</span><span class="n">reset</span><span class="p">(</span><span class="n">_reset</span><span class="p">);</span>
        <span class="n">_reset</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h5 id="24判断类型">2.4、判断类型</h5>

<p>分析请看注释：</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">AMF</span><span class="o">::</span><span class="n">Type</span> <span class="n">AMFReader</span><span class="o">::</span><span class="n">followingType</span><span class="p">()</span> <span class="p">{</span>
</code></pre></div></div>

<p>先 <code class="language-plaintext highlighter-rouge">reset</code>：</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">reset</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">_amf3</span> <span class="o">!=</span> <span class="n">reader</span><span class="p">.</span><span class="n">position</span><span class="p">())</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">_objectDefs</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">_amf3</span> <span class="o">=</span> <span class="n">_objectDefs</span><span class="p">.</span><span class="n">back</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">amf3</span><span class="p">;</span>
</code></pre></div></div>

<p>是 AMF0 类型：</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="k">else</span>
            <span class="n">_amf3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="err">}</span>
</code></pre></div></div>

<p>如果没有可读数据了，则返回 AMF::End。</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">available</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">AMF</span><span class="o">::</span><span class="n">End</span><span class="p">;</span>
</code></pre></div></div>

<p>开始读了，先读到的表示 AMF 数据类型。要注意的是调用 current 并不改变指针的位置，所以你会在线面看到调用 next。</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">UInt8</span> <span class="n">type</span> <span class="o">=</span> <span class="n">current</span><span class="p">();</span>
 
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_amf3</span> <span class="o">&amp;&amp;</span> <span class="n">type</span> <span class="o">==</span> <span class="n">AMF_AVMPLUS_OBJECT</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">reader</span><span class="p">.</span><span class="n">next</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="n">_amf3</span> <span class="o">=</span> <span class="n">reader</span><span class="p">.</span><span class="n">position</span><span class="p">();</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">available</span><span class="p">())</span>
            <span class="k">return</span> <span class="n">AMF</span><span class="o">::</span><span class="n">End</span><span class="p">;</span>
        <span class="n">type</span> <span class="o">=</span> <span class="n">current</span><span class="p">();</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>AMF3 类型</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">if</span> <span class="p">(</span><span class="n">_amf3</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">switch</span><span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
</code></pre></div></div>

<p>Undefined 和 null 都当做 null。</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>            <span class="k">case</span> <span class="n">AMF3_UNDEFINED</span><span class="p">:</span>
            <span class="k">case</span> <span class="n">AMF3_NULL</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">AMF</span><span class="o">::</span><span class="n">Null</span><span class="p">;</span>
</code></pre></div></div>

<p>false 和 true 都是 boolean。</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>            <span class="k">case</span> <span class="n">AMF3_FALSE</span><span class="p">:</span>
            <span class="k">case</span> <span class="n">AMF3_TRUE</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">AMF</span><span class="o">::</span><span class="n">Boolean</span><span class="p">;</span>
            <span class="k">case</span> <span class="n">AMF3_INTEGER</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">AMF</span><span class="o">::</span><span class="n">Integer</span><span class="p">;</span>
            <span class="k">case</span> <span class="n">AMF3_NUMBER</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">AMF</span><span class="o">::</span><span class="n">Number</span><span class="p">;</span>
            <span class="k">case</span> <span class="n">AMF3_STRING</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">AMF</span><span class="o">::</span><span class="n">String</span><span class="p">;</span>
            <span class="k">case</span> <span class="n">AMF3_DATE</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">AMF</span><span class="o">::</span><span class="n">Date</span><span class="p">;</span>
            <span class="k">case</span> <span class="n">AMF3_ARRAY</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">AMF</span><span class="o">::</span><span class="n">Array</span><span class="p">;</span>
            <span class="k">case</span> <span class="n">AMF3_DICTIONARY</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">AMF</span><span class="o">::</span><span class="n">Dictionary</span><span class="p">;</span>
            <span class="k">case</span> <span class="n">AMF3_OBJECT</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">AMF</span><span class="o">::</span><span class="n">Object</span><span class="p">;</span>
            <span class="k">case</span> <span class="n">AMF3_BYTEARRAY</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">AMF</span><span class="o">::</span><span class="n">ByteArray</span><span class="p">;</span>
</code></pre></div></div>

<p>落到 default 手里的话，就跳过这个字节，读取下一个。</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>            <span class="nl">default:</span>
                <span class="n">ERROR</span><span class="p">(</span><span class="s">"Unknown AMF3 type %.2x"</span><span class="p">,</span><span class="n">type</span><span class="p">)</span>
                <span class="n">reader</span><span class="p">.</span><span class="n">next</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
                <span class="k">return</span> <span class="nf">followingType</span><span class="p">();</span>
        <span class="err">}</span>
    <span class="err">}</span>
</code></pre></div></div>

<p>AMF0 类型</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">undefined</code> 和 <code class="language-plaintext highlighter-rouge">null</code> 都是 <code class="language-plaintext highlighter-rouge">null</code></p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="k">case</span> <span class="n">AMF_UNDEFINED</span><span class="p">:</span>
        <span class="k">case</span> <span class="n">AMF_NULL</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">AMF</span><span class="o">::</span><span class="n">Null</span><span class="p">;</span>
 
        <span class="k">case</span> <span class="n">AMF_BOOLEAN</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">AMF</span><span class="o">::</span><span class="n">Boolean</span><span class="p">;</span>
        <span class="k">case</span> <span class="n">AMF_NUMBER</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">AMF</span><span class="o">::</span><span class="n">Number</span><span class="p">;</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">long string</code> 和 <code class="language-plaintext highlighter-rouge">string</code> 都是 <code class="language-plaintext highlighter-rouge">string</code></p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="k">case</span> <span class="n">AMF_LONG_STRING</span><span class="p">:</span>
        <span class="k">case</span> <span class="n">AMF_STRING</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">AMF</span><span class="o">::</span><span class="n">String</span><span class="p">;</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">mixed array</code> 和 <code class="language-plaintext highlighter-rouge">strict array</code> 都是 <code class="language-plaintext highlighter-rouge">array</code></p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="k">case</span> <span class="n">AMF_MIXED_ARRAY</span><span class="p">:</span>
        <span class="k">case</span> <span class="n">AMF_STRICT_ARRAY</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">AMF</span><span class="o">::</span><span class="n">Array</span><span class="p">;</span>
 
        <span class="k">case</span> <span class="n">AMF_DATE</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">AMF</span><span class="o">::</span><span class="n">Date</span><span class="p">;</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">begin object</code> 和 <code class="language-plaintext highlighter-rouge">begin typed object</code> 都是 <code class="language-plaintext highlighter-rouge">object</code></p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="k">case</span> <span class="n">AMF_BEGIN_OBJECT</span><span class="p">:</span>
        <span class="k">case</span> <span class="n">AMF_BEGIN_TYPED_OBJECT</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">AMF</span><span class="o">::</span><span class="n">Object</span><span class="p">;</span>
</code></pre></div></div>

<p>如果是引用，就跳过表示类型值的这个字节。这个先留下来，带我们分析完 readArray 和 readObject 再回头看。</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="k">case</span> <span class="n">AMF_REFERENCE</span><span class="p">:</span> <span class="p">{</span>
            <span class="n">reader</span><span class="p">.</span><span class="n">next</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
            <span class="n">UInt16</span> <span class="n">reference</span> <span class="o">=</span> <span class="n">reader</span><span class="p">.</span><span class="n">read16</span><span class="p">();</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">reference</span> <span class="o">&gt;</span> <span class="n">_amf0References</span><span class="p">.</span><span class="n">size</span><span class="p">())</span> <span class="p">{</span>
                <span class="n">ERROR</span><span class="p">(</span><span class="s">"AMF0 reference not found"</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">followingType</span><span class="p">();</span>
            <span class="p">}</span>
            <span class="n">_amf0Reset</span> <span class="o">=</span> <span class="n">reader</span><span class="p">.</span><span class="n">position</span><span class="p">();</span>
            <span class="n">reader</span><span class="p">.</span><span class="n">reset</span><span class="p">(</span><span class="n">_amf0References</span><span class="p">[</span><span class="n">reference</span><span class="p">]);</span>
            <span class="k">return</span> <span class="n">followingType</span><span class="p">();</span>
        <span class="p">}</span>
</code></pre></div></div>

<p>如果没了，或者不支持，或者都不是，就跳过这个字节，递归继续读取：</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="k">case</span> <span class="n">AMF_END_OBJECT</span><span class="p">:</span>
            <span class="n">ERROR</span><span class="p">(</span><span class="s">"AMF end object type without begin object type before"</span><span class="p">)</span>
            <span class="n">reader</span><span class="p">.</span><span class="n">next</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
            <span class="k">return</span> <span class="nf">followingType</span><span class="p">();</span>
        <span class="k">case</span> <span class="n">AMF_UNSUPPORTED</span><span class="p">:</span>
            <span class="n">WARN</span><span class="p">(</span><span class="s">"Unsupported type in AMF format"</span><span class="p">)</span>
            <span class="n">reader</span><span class="p">.</span><span class="n">next</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
            <span class="k">return</span> <span class="nf">followingType</span><span class="p">();</span>
        <span class="k">default</span><span class="o">:</span>
            <span class="n">ERROR</span><span class="p">(</span><span class="s">"Unknown AMF type %.2x"</span><span class="p">,</span><span class="n">type</span><span class="p">)</span>
            <span class="n">reader</span><span class="p">.</span><span class="n">next</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
            <span class="k">return</span> <span class="nf">followingType</span><span class="p">();</span>
    <span class="err">}</span>
<span class="err">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">followingType</code> 是这个类的核心，每个具体的数据类型的分析都依赖于它的判断。这些类型的解析，会在下一篇文章中介绍。</p>

<h4 id="3解析-as3-null">3、解析 AS3 <code class="language-plaintext highlighter-rouge">Null</code></h4>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="n">AMFReader</span><span class="o">::</span><span class="n">readNull</span><span class="p">()</span> <span class="p">{</span>
</code></pre></div></div>

<p>先 reset 一下是惯例，就像糗百上的割一样。。</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">reset</span><span class="p">();</span> 
</code></pre></div></div>

<p>AMF 数据类型</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">AMF</span><span class="o">::</span><span class="n">Type</span> <span class="n">type</span> <span class="o">=</span> <span class="n">followingType</span><span class="p">();</span>
</code></pre></div></div>

<p>如果是 <code class="language-plaintext highlighter-rouge">Null</code>，跳过该字节，并返回</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">AMF</span><span class="o">::</span><span class="n">Null</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">reader</span><span class="p">.</span><span class="n">next</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>判断错误</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">ERROR</span><span class="p">(</span><span class="s">"Type %.2x is not a AMF Null type"</span><span class="p">,</span><span class="n">type</span><span class="p">);</span>
<span class="err">}</span>
</code></pre></div></div>

<h4 id="4解析-as3-number">4、解析 AS3 <code class="language-plaintext highlighter-rouge">Number</code></h4>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">double</span> <span class="n">AMFReader</span><span class="o">::</span><span class="n">readNumber</span><span class="p">()</span> <span class="p">{</span>
</code></pre></div></div>

<p>惯例：</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">reset</span><span class="p">();</span>
</code></pre></div></div>

<p>类型：</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">AMF</span><span class="o">::</span><span class="n">Type</span> <span class="n">type</span> <span class="o">=</span> <span class="n">followingType</span><span class="p">();</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">Null</code> 会被悲催的跳过：</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">AMF</span><span class="o">::</span><span class="n">Null</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">reader</span><span class="p">.</span><span class="n">next</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>不是 <code class="language-plaintext highlighter-rouge">Number</code> 呀 :(</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">!=</span> <span class="n">AMF</span><span class="o">::</span><span class="n">Number</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ERROR</span><span class="p">(</span><span class="s">"Type %.2x is not a AMF Number type"</span><span class="p">,</span><span class="n">type</span><span class="p">);</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>跳过该字节吧</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">reader</span><span class="p">.</span><span class="n">next</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</code></pre></div></div>

<p>返回吧，返回之前还用到 <code class="language-plaintext highlighter-rouge">Poco::BinaryReader</code> 的运算符，注意 AS3 中的 <code class="language-plaintext highlighter-rouge">Number</code> 就是 C++ 的 <code class="language-plaintext highlighter-rouge">double</code>。</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="kt">double</span> <span class="n">result</span><span class="p">;</span>
    <span class="n">reader</span> <span class="o">&gt;&gt;</span> <span class="n">result</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="err">}</span>
</code></pre></div></div>

<h4 id="5解析-as3-integer">5、解析 AS3 <code class="language-plaintext highlighter-rouge">Integer</code></h4>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Int32</span> <span class="n">AMFReader</span><span class="o">::</span><span class="n">readInteger</span><span class="p">()</span> <span class="p">{</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">reset</code> 类型：</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">reset</span><span class="p">();</span>
    <span class="n">AMF</span><span class="o">::</span><span class="n">Type</span> <span class="n">type</span> <span class="o">=</span> <span class="n">followingType</span><span class="p">();</span>
</code></pre></div></div>

<p>Null 的话：</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">AMF</span><span class="o">::</span><span class="n">Null</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">reader</span><span class="p">.</span><span class="n">next</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>不是 <code class="language-plaintext highlighter-rouge">Integer</code> 或者 Number 的话。。。</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">!=</span> <span class="n">AMF</span><span class="o">::</span><span class="n">Integer</span> <span class="o">&amp;&amp;</span> <span class="n">type</span> <span class="o">!=</span> <span class="n">AMF</span><span class="o">::</span><span class="n">Number</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ERROR</span><span class="p">(</span><span class="s">"Type %.2x is not a AMF Integer type"</span><span class="p">,</span><span class="n">type</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>跳过吧。</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">reader</span><span class="p">.</span><span class="n">next</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</code></pre></div></div>

<p>终于是 <code class="language-plaintext highlighter-rouge">Number</code> 了。</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">AMF</span><span class="o">::</span><span class="n">Number</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">double</span> <span class="n">result</span><span class="p">;</span>
        <span class="n">reader</span> <span class="o">&gt;&gt;</span> <span class="n">result</span><span class="p">;</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">Int32</span><span class="p">)</span><span class="n">result</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>读一个变长的 32 位无符号整数：</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="c1">// Forced in AMF3 here!</span>
    <span class="n">UInt32</span> <span class="n">value</span> <span class="o">=</span> <span class="n">reader</span><span class="p">.</span><span class="n">read7BitValue</span><span class="p">();</span>
</code></pre></div></div>

<p>如果大于 3.5 个字节所能表示的最大无符号整数值（<code class="language-plaintext highlighter-rouge">268435455</code> 是 <code class="language-plaintext highlighter-rouge">0xFFFFFFF</code>），则减去 <code class="language-plaintext highlighter-rouge">0x2FFFFFFF</code>（这还不是太理解，有能解释的朋友给留个言，或者发 email 给我 ）</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;</span> <span class="mi">268435455</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">-=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">29</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">value</span><span class="p">;</span>
<span class="err">}</span>
</code></pre></div></div>

<h4 id="6解析-as3-boolean">6、解析 AS3 <code class="language-plaintext highlighter-rouge">Boolean</code></h4>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">bool</span> <span class="n">AMFReader</span><span class="o">::</span><span class="n">readBoolean</span><span class="p">()</span> <span class="p">{</span>
</code></pre></div></div>

<p>惯例：</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">reset</span><span class="p">();</span>
    <span class="n">AMF</span><span class="o">::</span><span class="n">Type</span> <span class="n">type</span> <span class="o">=</span> <span class="n">followingType</span><span class="p">();</span>
</code></pre></div></div>

<p>如果是 <code class="language-plaintext highlighter-rouge">Null</code>：</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">AMF</span><span class="o">::</span><span class="n">Null</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">reader</span><span class="p">.</span><span class="n">next</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>居然不是 <code class="language-plaintext highlighter-rouge">Boolean</code> 的话。。</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">!=</span> <span class="n">AMF</span><span class="o">::</span><span class="n">Boolean</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ERROR</span><span class="p">(</span><span class="s">"Type %.2x is not a AMF Boolean type"</span><span class="p">,</span><span class="n">type</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>如果是 <code class="language-plaintext highlighter-rouge">AMF3</code> 的话，返回 <code class="language-plaintext highlighter-rouge">true</code> 或者 <code class="language-plaintext highlighter-rouge">false</code>：</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">if</span> <span class="p">(</span><span class="n">_amf3</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">reader</span><span class="p">.</span><span class="n">read8</span><span class="p">()</span><span class="o">==</span> <span class="n">AMF3_FALSE</span> <span class="o">?</span> <span class="nb">false</span> <span class="o">:</span> <span class="nb">true</span><span class="p">;</span>
</code></pre></div></div>

<p>不是 <code class="language-plaintext highlighter-rouge">AMF3</code> 就是 <code class="language-plaintext highlighter-rouge">AMF0</code> 喽：</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">reader</span><span class="p">.</span><span class="n">next</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">reader</span><span class="p">.</span><span class="n">read8</span><span class="p">()</span><span class="o">==</span><span class="mh">0x00</span> <span class="o">?</span> <span class="nb">false</span> <span class="o">:</span> <span class="nb">true</span><span class="p">;</span>
<span class="err">}</span>
</code></pre></div></div>

<h4 id="7开始引用与结束引用">7、开始引用与结束引用</h4>

<p>如下这两个函数会在 <code class="language-plaintext highlighter-rouge">FlowConnection</code> 中调用。</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kr">inline</span> <span class="kt">void</span> <span class="n">AMFReader</span><span class="o">::</span><span class="n">startReferencing</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">_referencing</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>
 
<span class="kr">inline</span> <span class="kt">void</span> <span class="n">AMFReader</span><span class="o">::</span><span class="n">stopReferencing</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">_referencing</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="8解析-as3-bytearray">8、解析 AS3 <code class="language-plaintext highlighter-rouge">ByteArray</code></h4>

<p>先回顾一下 AMF3 中的ByteArray 的数据格式：</p>

<p>注意到，首先要读取一个变长无符号 32 位整数，但是最低位是 1，只有 28 位用于表示数据长度。解释完这里，下面的解析过程才好理解。</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">BinaryReader</span><span class="o">&amp;</span> <span class="n">AMFReader</span><span class="o">::</span><span class="n">readByteArray</span><span class="p">(</span><span class="n">UInt32</span><span class="o">&amp;</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
</code></pre></div></div>

<p>惯例：</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">reset</span><span class="p">();</span>
    <span class="n">AMF</span><span class="o">::</span><span class="n">Type</span> <span class="n">type</span> <span class="o">=</span> <span class="n">followingType</span><span class="p">();</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">Null</code> 就返回 <code class="language-plaintext highlighter-rouge">BinaryReaderNull</code>。</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">AMF</span><span class="o">::</span><span class="n">Null</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">reader</span><span class="p">.</span><span class="n">next</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">BinaryReader</span><span class="o">::</span><span class="n">BinaryReaderNull</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>如果不是 <code class="language-plaintext highlighter-rouge">ByteArray</code>，也返回 <code class="language-plaintext highlighter-rouge">BinaryReaderNull</code>：</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">!=</span> <span class="n">AMF</span><span class="o">::</span><span class="n">ByteArray</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ERROR</span><span class="p">(</span><span class="s">"Type %.2x is not a AMF ByteArray type"</span><span class="p">,</span><span class="n">type</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">BinaryReader</span><span class="o">::</span><span class="n">BinaryReaderNull</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>跳过这个字节：</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">reader</span><span class="p">.</span><span class="n">next</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</code></pre></div></div>

<p>注意 position 返回的是相对位置，与 AS3 中一样。<code class="language-plaintext highlighter-rouge">reference</code> 表示这个地址（简单说，引用就是地址嘛）。</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">UInt32</span> <span class="n">reference</span> <span class="o">=</span> <span class="n">reader</span><span class="p">.</span><span class="n">position</span><span class="p">();</span>
</code></pre></div></div>

<p>读取一个变长 32 位无符号整数：</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">size</span> <span class="o">=</span> <span class="n">reader</span><span class="p">.</span><span class="n">read7BitValue</span><span class="p">();</span>
</code></pre></div></div>

<p>最低位是 1 的话，<code class="language-plaintext highlighter-rouge">isInline</code> 是 <code class="language-plaintext highlighter-rouge">true</code>，否则为 <code class="language-plaintext highlighter-rouge">false</code>。</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="kt">bool</span> <span class="n">isInline</span> <span class="o">=</span> <span class="n">size</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">;</span>
</code></pre></div></div>

<p>右移一位，因为那一位是标志位，上面解释过了。</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">size</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
</code></pre></div></div>

<p>如果 <code class="language-plaintext highlighter-rouge">isInline</code> 是 <code class="language-plaintext highlighter-rouge">true</code>，表示是 <code class="language-plaintext highlighter-rouge">ByteArray</code>：</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">if</span> <span class="p">(</span><span class="n">isInline</span><span class="p">)</span> <span class="p">{</span>
</code></pre></div></div>

<p>如果 <code class="language-plaintext highlighter-rouge">_referencing</code> 为 <code class="language-plaintext highlighter-rouge">true</code> 的话（这是一个 <code class="language-plaintext highlighter-rouge">vector</code>），push back this reference：</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="k">if</span> <span class="p">(</span><span class="n">_referencing</span><span class="p">)</span>
            <span class="n">_references</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">reference</span><span class="p">);</span>
    <span class="err">}</span>
</code></pre></div></div>

<p>不符合 ByteArray 的格式定义的话：</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">_references</span><span class="p">.</span><span class="n">size</span><span class="p">())</span> <span class="p">{</span>
            <span class="n">ERROR</span><span class="p">(</span><span class="s">"AMF3 reference not found"</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">BinaryReader</span><span class="o">::</span><span class="n">BinaryReaderNull</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">_reset</span> <span class="o">=</span> <span class="n">reader</span><span class="p">.</span><span class="n">position</span><span class="p">();</span>
</code></pre></div></div>

<p>移动到这个 reference 的位置，<code class="language-plaintext highlighter-rouge">_references[size]</code> 就是这个位置（相对）。</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="n">reader</span><span class="p">.</span><span class="n">reset</span><span class="p">(</span><span class="n">_references</span><span class="p">[</span><span class="n">size</span><span class="p">]);</span> <span class="c1">// TODO size 作为索引，还没有完全理解</span>
</code></pre></div></div>

<p>读取这个 reference 的 size 值给 size对象（注意 size 是这个函数传入的引用参数，其值可以被修改）。</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="n">size</span> <span class="o">=</span> <span class="n">reader</span><span class="p">.</span><span class="n">read7BitValue</span><span class="p">()</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
    <span class="err">}</span>
</code></pre></div></div>

<p>把读取完 ByteArraty 的 PacketReader 返回：</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">return</span> <span class="n">reader</span><span class="p">;</span>
<span class="err">}</span>
</code></pre></div></div>

<p>最后强调一点，<code class="language-plaintext highlighter-rouge">ByteArray</code> 的数据段最大长度为 228 -1 字节，约为 256 MB。</p>

<h4 id="9解析-as3-date">9、解析 AS3 <code class="language-plaintext highlighter-rouge">Date</code></h4>

<p>先看下 <code class="language-plaintext highlighter-rouge">Date</code> 的数据格式：</p>

<p>下面开始分析：</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Timestamp</span> <span class="n">AMFReader</span><span class="o">::</span><span class="n">readDate</span><span class="p">()</span> <span class="p">{</span>
</code></pre></div></div>

<p>惯例：</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">reset</span><span class="p">();</span>
    <span class="n">AMF</span><span class="o">::</span><span class="n">Type</span> <span class="n">type</span> <span class="o">=</span> <span class="n">followingType</span><span class="p">();</span>
</code></pre></div></div>

<p>Null 的话，就返回当前时间：</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">AMF</span><span class="o">::</span><span class="n">Null</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">reader</span><span class="p">.</span><span class="n">next</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">Timestamp</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>如果不是 Date 类型，也返回当前时间：</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">!=</span> <span class="n">AMF</span><span class="o">::</span><span class="n">Date</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ERROR</span><span class="p">(</span><span class="s">"Type %.2x is not a AMF Date type"</span><span class="p">,</span><span class="n">type</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">Timestamp</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>
 
    <span class="n">reader</span><span class="p">.</span><span class="n">next</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="kt">double</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</code></pre></div></div>

<p>如果是 AMF3：</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">if</span> <span class="p">(</span><span class="n">_amf3</span><span class="p">)</span> <span class="p">{</span>
</code></pre></div></div>

<p>先读取 flag，最低一位必须是 1，其他位丢到垃圾桶。</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="n">UInt32</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">reader</span><span class="p">.</span><span class="n">read7BitValue</span><span class="p">();</span>
</code></pre></div></div>

<p>当前相对位置。</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="n">UInt32</span> <span class="n">reference</span> <span class="o">=</span> <span class="n">reader</span><span class="p">.</span><span class="n">position</span><span class="p">();</span>
</code></pre></div></div>

<p>是 1 就 push back 到 <code class="language-plaintext highlighter-rouge">_references</code> 里。</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="kt">bool</span> <span class="n">isInline</span> <span class="o">=</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">isInline</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="n">_referencing</span><span class="p">)</span>
                <span class="n">_references</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">reference</span><span class="p">);</span>
</code></pre></div></div>

<p>读取一个 double，到 result 里（result 也是 double 类型哦~）。</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>            <span class="n">reader</span> <span class="o">&gt;&gt;</span> <span class="n">result</span><span class="p">;</span>
        <span class="err">}</span>
</code></pre></div></div>

<p>如果标志位不是 1，麻烦不少哒。。。</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="k">else</span> <span class="p">{</span>
            <span class="n">flags</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
</code></pre></div></div>

<p>如果 flag 超了，就返回当前时间作为时间戳作为 Date。</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>            <span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&gt;</span> <span class="n">_references</span><span class="p">.</span><span class="n">size</span><span class="p">())</span> <span class="p">{</span>
                <span class="n">ERROR</span><span class="p">(</span><span class="s">"AMF3 reference not found"</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">Timestamp</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
            <span class="p">}</span>
</code></pre></div></div>

<p>这段与 ByteArray 那段一样：</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>            <span class="n">_reset</span> <span class="o">=</span> <span class="n">reader</span><span class="p">.</span><span class="n">position</span><span class="p">();</span>
            <span class="n">reader</span><span class="p">.</span><span class="n">reset</span><span class="p">(</span><span class="n">_references</span><span class="p">[</span><span class="n">flags</span><span class="p">]);</span>
            <span class="n">reader</span> <span class="o">&gt;&gt;</span> <span class="n">result</span><span class="p">;</span>
            <span class="n">reset</span><span class="p">();</span>
        <span class="err">}</span>
</code></pre></div></div>

<p>返回喽~</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="k">return</span> <span class="nf">Timestamp</span><span class="p">((</span><span class="n">Timestamp</span><span class="o">::</span><span class="n">TimeVal</span><span class="p">)</span> <span class="n">result</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">);</span>
    <span class="err">}</span>
    <span class="n">reader</span> <span class="o">&gt;&gt;</span> <span class="n">result</span><span class="p">;</span>
</code></pre></div></div>

<p>读俩，因为是 double（64 位）：</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">reader</span><span class="p">.</span><span class="n">next</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span> <span class="c1">// Timezone, useless</span>
</code></pre></div></div>

<p>返回喽~</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">return</span> <span class="nf">Timestamp</span><span class="p">((</span><span class="n">Timestamp</span><span class="o">::</span><span class="n">TimeVal</span><span class="p">)</span> <span class="n">result</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">);</span>
<span class="err">}</span>
</code></pre></div></div>

<h4 id="10解析-as3-dictionary">10、解析 AS3 <code class="language-plaintext highlighter-rouge">Dictionary</code></h4>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">bool</span> <span class="n">AMFReader</span><span class="o">::</span><span class="n">readDictionary</span><span class="p">(</span><span class="kt">bool</span><span class="o">&amp;</span> <span class="n">weakKeys</span><span class="p">)</span> <span class="p">{</span>
</code></pre></div></div>

<p>下面这段咱就略了。。</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">reset</span><span class="p">();</span>
    <span class="n">AMF</span><span class="o">::</span><span class="n">Type</span> <span class="n">type</span> <span class="o">=</span> <span class="n">followingType</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">AMF</span><span class="o">::</span><span class="n">Null</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">reader</span><span class="p">.</span><span class="n">next</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">!=</span> <span class="n">AMF</span><span class="o">::</span><span class="n">Dictionary</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ERROR</span><span class="p">(</span><span class="s">"Type %.2x is not a AMF Dictionary type"</span><span class="p">,</span><span class="n">type</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>跳过 type：</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="c1">// AMF3</span>
    <span class="n">reader</span><span class="p">.</span><span class="n">next</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="c1">// marker</span>
</code></pre></div></div>

<p>当前相对位置值作为 <code class="language-plaintext highlighter-rouge">reference</code>，再读个 <code class="language-plaintext highlighter-rouge">size</code>，还是最低位必须为 1，不是就返回 <code class="language-plaintext highlighter-rouge">false</code>。</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">UInt32</span> <span class="n">reference</span> <span class="o">=</span> <span class="n">reader</span><span class="p">.</span><span class="n">position</span><span class="p">();</span>
    <span class="n">UInt32</span> <span class="n">size</span> <span class="o">=</span> <span class="n">reader</span><span class="p">.</span><span class="n">read7BitValue</span><span class="p">();</span>
    <span class="kt">bool</span> <span class="n">isInline</span> <span class="o">=</span> <span class="n">size</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">;</span>
    <span class="n">size</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">isInline</span> <span class="o">&amp;&amp;</span> <span class="n">size</span><span class="o">&gt;</span><span class="n">_references</span><span class="p">.</span><span class="n">size</span><span class="p">())</span> <span class="p">{</span>
        <span class="n">ERROR</span><span class="p">(</span><span class="s">"AMF3 reference not found"</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>下面要调用到 <code class="language-plaintext highlighter-rouge">ObjectRef</code> 构造函数，这里再把其实现拿出来看看，其实主要是初始化了哪些成员。</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ObjectDef</span><span class="p">(</span><span class="n">UInt32</span> <span class="n">amf3</span><span class="p">,</span><span class="n">UInt8</span> <span class="n">arrayType</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="o">:</span> <span class="n">amf3</span><span class="p">(</span><span class="n">amf3</span><span class="p">),</span>
      <span class="n">reset</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
      <span class="n">dynamic</span><span class="p">(</span><span class="nb">false</span><span class="p">),</span>
      <span class="n">externalizable</span><span class="p">(</span><span class="nb">false</span><span class="p">),</span>
      <span class="n">count</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
      <span class="n">arrayType</span><span class="p">(</span><span class="n">arrayType</span><span class="p">)</span> <span class="p">{</span>
<span class="p">}</span>
</code></pre></div></div>

<p>可以看到要有一个 amf3，还有 <code class="language-plaintext highlighter-rouge">reset</code> 置为 0，<code class="language-plaintext highlighter-rouge">dynamic</code> 置为 <code class="language-plaintext highlighter-rouge">false</code>，<code class="language-plaintext highlighter-rouge">externalizable</code> 也是 <code class="language-plaintext highlighter-rouge">false</code>，<code class="language-plaintext highlighter-rouge">count</code> 是 0，<code class="language-plaintext highlighter-rouge">arrayType</code> 成员要赋值。</p>

<p>上面是插播哦，下面还要继续哒。创建这么一个对象，注意是 new 出来的，所以我们在《OpenRTMFP/Cumulus Primer（16）AMF解析之AMFReader》一文中提到了 AMFReader 的析构函数中要对 <code class="language-plaintext highlighter-rouge">_objectRef</code> 的每个元素逐一析构的。<code class="language-plaintext highlighter-rouge">arrayType</code> 就设置为 <code class="language-plaintext highlighter-rouge">AMF3_DICTIONARY</code>。</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">ObjectDef</span><span class="o">*</span> <span class="n">pObjectDef</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">ObjectDef</span><span class="p">(</span><span class="n">_amf3</span><span class="p">,</span> <span class="n">AMF3_DICTIONARY</span><span class="p">);</span>
    <span class="n">pObjectDef</span><span class="o">-&gt;</span><span class="n">dynamic</span><span class="o">=</span><span class="nb">true</span><span class="p">;</span>
    <span class="n">_objectDefs</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">pObjectDef</span><span class="p">);</span>
</code></pre></div></div>

<p>如果标志位是 1，就直接 push back，跟之前一样。不过这里多了一个 <code class="language-plaintext highlighter-rouge">pObjectDef</code>，所以还要设置一下它的计数为 <code class="language-plaintext highlighter-rouge">size</code>，就是 <code class="language-plaintext highlighter-rouge">dictionary</code> 数据大小。</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">if</span> <span class="p">(</span><span class="n">isInline</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">_referencing</span><span class="p">)</span>
            <span class="n">_references</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">reference</span><span class="p">);</span>
        <span class="n">pObjectDef</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>如果标志位是 0，就把 <code class="language-plaintext highlighter-rouge">count</code> 设置为下一个变长整数值。</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">else</span> <span class="p">{</span>
        <span class="n">pObjectDef</span><span class="o">-&gt;</span><span class="n">reset</span> <span class="o">=</span> <span class="n">reader</span><span class="p">.</span><span class="n">position</span><span class="p">();</span>
        <span class="n">reader</span><span class="p">.</span><span class="n">reset</span><span class="p">(</span><span class="n">_references</span><span class="p">[</span><span class="n">size</span><span class="p">]);</span>
        <span class="n">pObjectDef</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="n">reader</span><span class="p">.</span><span class="n">read7BitValue</span><span class="p">()</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">pObjectDef</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
</code></pre></div></div>

<p>读一个字节，如果最小位是 1，weakKeys 就是 true，否则为 false。</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">weakKeys</span> <span class="o">=</span> <span class="n">reader</span><span class="p">.</span><span class="n">read8</span><span class="p">()</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">;</span>
 
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="err">}</span>
</code></pre></div></div>

	</div>
</article>



	  </main>
		
		  <!-- Pagination links -->
      

	  </div>
	    
	    <!-- Footer -->
	    <footer>
	<span>
		-<br/><br/>
		船长还不会游泳 at 微信公众号/微博<br/>
		@麦克船长 at 即刻/知乎/小宇宙/掘金/小红书/微信读书<br/>
		@船长模玩 at Bilibili<br/>
		Copyright © 2011-2023, MikeCaptain.com
	</span>
</footer>


	    <!-- Script -->
      <script src="/js/main.js"></script>	


	</div>
</body>
</html>
